<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load cloudinary %}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="{% block meta_description %}{% endblock %} LeafyReads is your personal reading sanctuary. Discover thousands of books, track your reading progress, and connect with a community of book lovers." />
  {% block social_tags %}{% endblock %}
    <title>
    {% block title %}

    {% endblock %}
  </title>
  <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=96 height=96 crop='scale' %}" sizes="96x96" type="image/png">
  <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=48 height=48 crop='scale' %}" sizes="48x48" type="image/png">
  <link rel="apple-touch-icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=180 height=180 crop='scale' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'css/home.css' %}" />
  <link rel="stylesheet" href="{% static 'css/searchnav.css' %}" />
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />
  <style>
    .desktop-nav a.active {
      color: #149546 !important;
    }

    /* ---------------------------------- */
    /* Tablet (<= 1024px)                 */
    /* ---------------------------------- */
    @media (max-width: 1024px) {

      .header-content {
        gap: 20px;
      }

      .desktop-nav a {
        font-size: 0.95rem;
        padding: 6px 10px;
      }

      .nav-search-wrapper {
        width: 180px;
      }

      .nav-search-input {
        font-size: 0.9rem;
      }

      .header-actions .btn,
      .theme-toggle-btn {
        padding: 6px;
      }

      .logo-light,
      .logo-dark {
        width: 110px !important;
      }
    }


    /* ---------------------------------- */
    /* Mobile (<= 768px)                  */
    /* ---------------------------------- */
    @media (max-width: 768px) {

      .header-content {
        justify-content: space-between;
      }

      .navcontainer {
        width: 100%;
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }

      /* Hide desktop links */
      .desktop-nav a,
      .desktop-nav form,
      .nav-results {
        display: none !important;
      }

      /* Use a hamburger for mobile (you can hook JS later) */
      .mobile-menu-btn {
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        cursor: pointer;
      }


      .logo-light,
      .logo-dark {
        width: 105px !important;
      }

      /* Header Actions on mobile */
      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .theme-toggle-btn {
        padding: 6px;
        display: none;
      }

      #dropdown-button {
        font-size: 0.85rem;
        padding: 6px 10px;
      }
    }


    /* ---------------------------------- */
    /* Small Mobile (<= 480px)            */
    /* ---------------------------------- */
    @media (max-width: 480px) {

      .header {
        padding: 5px;
      }

      .header-actions {
        gap: 8px;
      }

      #dropdown-button {
        font-size: 0.78rem;
      }

      .theme-toggle-btn i,
      .header-actions i {
        width: 18px;
        height: 18px;
        display: none;
      }
    }
  </style>

  {% block css %}

  {% endblock %}
</head>

<body>
  {% include 'loader.html' %}
  <header class="header">
    <div class="container navcontainer">
      <div class="header-content">
       <a href="/" class="logo">
          {% cloudinary "qqeschqzlywacz6rqsbl" class="logo-icon" style="width: 48px; border-radius: 15px;" alt="logo" %}
          {% cloudinary "tdehybbsyciqodgxs2rq" class="logo-light" style="width: 140px; border-radius: 15px;" alt="LeafyReads" %}
          {% cloudinary "kp6b6xlwuu8d52cfhfba" class="logo-dark" style="width: 140px; border-radius: 15px;" alt="LeafyReads" %}
      </a>
        <nav class="desktop-nav" style="position: relative;">
          <a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a>
          <a href="{% url 'library' %}" class="{% if request.path == '/book/library/' %}active{% endif %}">Library</a>
          {% if user.is_authenticated %}
          <a href="{% url 'myBooks' %}" class="{% if request.path == '/book/my-books/' %}active{% endif %}">Read
            Later</a>
          {% endif %}
          <a href="{% url 'community' %}" class="{% if request.path == '/community/' %}active{% endif %}">Community</a>
          <a href="{% url 'aboutUs' %}" class="{% if request.path == '/aboutus/' %}active{% endif %}">About Us</a>

          <form id="navSearch" class="nav-search-wrapper" action="{% url 'searchbooks' %}" method="get">
            <div id="navSearchBtn" class="nav-search-button" aria-label="Search">
              <i data-lucide="search"></i>
            </div>
            <input type="text" name="q" id="navSearchInput" class="nav-search-input"
              placeholder="Search for books, authors, or genres..." />
            <button type="submit" id="sctive"
              style="display: none;border: none; background: #149546;border-radius: 8px;color: white;padding: 5px;cursor:pointer;"><span>Search</span></button>
          </form>

          <div class="nav-results">
            <div class="nav-search-history"></div>
          </div>
        </nav>
        <div class="header-actions">
          <!-- Notification Pannel -->
          {% if user.is_authenticated %}
          <div class="notification-wrapper" style="position: relative; display: inline-block;">
            <button style="position: relative;" onclick="toggleNotifications()" aria-label="notification"
              class="notif-btn theme-toggle-btn"><i data-lucide="bell"></i>
              <p class="notify-dot"></p>
            </button>
            <div class="notification-box glass-panel" id="notificationBox">
              <div class="notif-header">
                <h3>Notifications</h3>
                <button class="mark-read-text">Mark all read</button>
              </div>

              <div class="notif-list">
                {% if notifications %}
                {% for notif in notifications %}

                {% if notif.notification_type == 'post_delete' %}
                <div class="notif-item" style="cursor: default;">
                  <div class="notif-icon-box bg-teal">
                    üóëÔ∏è
                  </div>
                  <div class="notif-content">
                    <p>{{ notif.message|safe }}</p>
                    <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
                  </div>
                </div>
                {% else %}
                <a href="{% url 'post_view' notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
                  <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
                    <div class="notif-icon-box bg-teal">
                      {% if notif.notification_type == 'like' %}‚ù§Ô∏è
                      {% elif notif.notification_type == 'comment' %}üí¨
                      {% elif notif.notification_type == 'book_mention' %}üìö
                      {% else %}üîî{% endif %}
                    </div>
                    <div class="notif-content">
                      <p>{{ notif.message|safe }}</p>
                      <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
                    </div>
                    {% if not notif.is_read %}
                    <div class="unread-dot"></div>
                    {% endif %}
                  </div>
                </a>
                {% endif %}

                {% endfor %}
                {% else %}
                <div style="padding: 1.5rem; text-align: center; color: #94a3b8; font-size: 0.85rem;">
                  <p>No new updates</p>
                </div>
                {% endif %}

                <div class="notif-item">
                  <div class="notif-icon-box bg-teal">
                    <i data-lucide="sparkles"></i>
                  </div>
                  <div class="notif-content">
                    <p><strong>Welcome to LeafyReads!</strong> üåø Discover new books...</p>
                    <span class="notif-time">{{ user.date_joined|timesince }} ago</span>
                  </div>
                </div>
              </div>
              <div class="notif-footer">
                <a href="#">View All History</a>
              </div>
            </div>
          </div>
          {% endif %}


          <button id="theme-toggle" aria-label="darklight" class="theme-toggle-btn theme-toggle-handler"><i
              data-lucide="sun"></i></button>
          {% if user.is_authenticated %}
          <div class="dropdown">
            <button id="dropdown-button" class="btn">Welcome {{ user.first_name }} <i
                data-lucide="arrow-big-down-dash"></i></button>

            <ul id="dropdown-menu" class="dropdown-menu hidden">
              {% if user.is_staff %}
              <a href="/admin-dashboard/">
                <li class="dropdown-item">
                  <i data-lucide="shield-check"></i>
                  <span>Admin Pannel</span>
                </li>
              </a>
              {% else %}
              <a href="{% url 'profilepage' %}">
                <li class="dropdown-item">
                  <i data-lucide="user-pen"></i>
                  <span>Profile</span>
                </li>
              </a>
              <li onclick="toggleNotifications()" class="dropdown-item" style="position: relative;">
                <i data-lucide="bell"></i>
                <p class="notify-dot" style="left: 25px;"></p>
                <span>Notification</span>
              </li>
              <li class="dropdown-item">
                <i data-lucide="gem"></i>
                <span>Go Pro</span>
              </li>

              <a href="{% url 'aboutUs' %}">
                <li class="dropdown-item">
                  <i data-lucide="info"></i>
                  <span>About Us</span>
                </li>
              </a>
              {% endif %}
              <li class="separator"></li>
              <a href="{% url 'logout' %}">
                <li class="dropdown-item">
                  <i data-lucide="log-out"></i>
                  <span>Logout</span>
                </li>
              </a>
            </ul>
          </div>
          {% else %}
          <div style="display: flex;align-items: center;justify-content: center;gap: 4px;" id="startlogin"
            class="btn primary-btn">
            <span>Start Reading Now</span><i style="width: 20px;" data-lucide="sparkles"></i>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </header>
  <div class="bottomnav">
    {% include 'mobilenav.html' %}
  </div>

  {% block body %}

  {% endblock %}

  <footer class="footer">
    <div class="container footer-content">
      <div class="footer-grid">
        <div class="footer-about">
          <div class="logo" style="margin-bottom: 1rem;">
            {% cloudinary "qqeschqzlywacz6rqsbl" class="logo-icon" style="width: 48px; border-radius: 15px;" alt="logo" %}
            <span style="color: white">LeafyReads</span>
          </div>
          <p style="color: #9CA3AF;">Your digital reading sanctuary.</p>
          <div style="margin-top: 15px;">
          <div class="footer-socials">
            <a href="#"><i data-lucide="twitter"></i></a>
            <a href="#"><i data-lucide="instagram"></i></a>
            <a href="#"><i data-lucide="facebook"></i></a>
          </div>
        </div>
        </div>
        <div>
          <h4>Company</h4>
          <ul>
            <li>
              <a href="{% url 'aboutUs' %}">About Us</a>
            </li>
            <li>
              <a href="#">Careers</a>
            </li>
            <li>
              <a href="mailto:support@leafyreads.com">Contact Us</a>   
            </li>
          </ul>
        </div>
        <div>
          <h4>Resources</h4>
          <ul>
            <li>
              <a href="#">Help Center</a>
            </li>
            <li>
              <a href="{% url 'privacy-policy' %}">Privacy</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="footer-copyright">&copy; 
        <a href="{% url 'copyright-policy' %}">2026 LeafyReads. All Rights Reserved.</a>
      </div>
    </div>
  </footer>
  <script src="{% static 'js/home.js' %}"></script>
  <script src="{% static 'js/navsearch.js' %}"></script>
  <script>

  window.toggleNotifications = function() {
    // 1. Force Close the Dropdown Menu if it's open
    const dropdown = document.getElementById('dropdown-menu');
    if (dropdown) {
      dropdown.classList.add('hidden'); 
    }

    // 2. Toggle the Notification Box
    const box = document.getElementById('notificationBox');
    if (box) box.classList.toggle('active');
  };

  // ==========================================
  //      2. MAIN EXECUTION
  // ==========================================
  document.addEventListener('DOMContentLoaded', () => {

    // --- A. LOADER LOGIC (Optimized) ---
    // Runs immediately when HTML is ready.
    const loader = document.getElementById('loader');
    const content = document.getElementById('content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.display = 'block';

    // --- B. LOGIN MODAL LOGIC ---
    const startlogin = document.getElementById('startlogin');
    const loginSection = document.getElementById('loginSection');
    const closelogin = document.getElementById('closelogin');

    if (startlogin && loginSection) {
      startlogin.addEventListener('click', () => {
        loginSection.classList.add('active');
      });

      if (closelogin) {
        closelogin.addEventListener('click', () => {
          loginSection.classList.remove('active');
        });
      }

      // Close when clicking the dark overlay background
      loginSection.addEventListener('click', (e) => {
        if (e.target === loginSection) {
          loginSection.classList.remove('active');
        }
      });
    }

    // --- C. DROPDOWN LOGIC ---
    const dropdownButton = document.getElementById('dropdown-button');
    const dropdownMenu = document.getElementById('dropdown-menu');

    if (dropdownButton && dropdownMenu) {
      dropdownButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent global click from closing it immediately
        dropdownMenu.classList.toggle('hidden');
      });
    }

    // --- D. NAV SEARCH LOGIC ---
    const navSearchForm = document.getElementById('navSearch');
    const navSearchInput = document.getElementById('navSearchInput');
    const navResultsBox = document.querySelector('.nav-results');
    const navHistoryContainer = navResultsBox ? navResultsBox.querySelector('.nav-search-history') : null;
    
    // Search Variables
    let currentController = null;
    let navTypingTimer;
    const navDebounceDelay = 300;
    
    // Skeleton HTML
    const skeletonHTML = `
      <div class="skeleton-item">
        <div class="skeleton-icon"></div>
        <div class="skeleton-text-col">
          <div class="skeleton-line long"></div>
          <div class="skeleton-line short"></div>
        </div>
      </div>`;

    if (navSearchInput && navResultsBox && navHistoryContainer && navSearchForm) {

      const escapeHtml = (unsafe) => {
        if (!unsafe) return "";
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      };

      const fetchNavResults = async (query) => {
        if (currentController) currentController.abort();
        currentController = new AbortController();

        // Show Loading
        navHistoryContainer.innerHTML = `<div class="nav-search-history-title">Searching...</div>${skeletonHTML}${skeletonHTML}`;
        
        try {
          const response = await fetch(`/book/ajax/search/?q=${encodeURIComponent(query)}`, {
            signal: currentController.signal
          });
          
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const data = await response.json();
          const results = data.results;

          navHistoryContainer.innerHTML = '';
          const fragment = document.createDocumentFragment();
          
          const titleEl = document.createElement('div');
          titleEl.className = 'nav-search-history-title';
          titleEl.textContent = `Results for "${query}"`;
          fragment.appendChild(titleEl);

          if (!results || results.length === 0) {
            const noResultEl = document.createElement('div');
            noResultEl.className = 'nav-history-item';
            noResultEl.innerHTML = `<i data-lucide="search"></i><div class="nav-history-item-info"><span class="nav-history-item-title">No results found</span></div>`;
            fragment.appendChild(noResultEl);
          } else {
            results.forEach((book) => {
              const link = document.createElement('a');
              link.href = `/book/library/book-details/${book.slug}`;
              link.className = 'nav-history-item';
              link.innerHTML = `
                <i style="width:40px;" data-lucide="notebook"></i>  
                <div class="nav-history-item-info">
                  <span class="nav-history-item-title">${escapeHtml(book.title)}</span>
                  <span class="nav-history-item-author">by ${escapeHtml(book.author)}</span>
                </div>`;
              fragment.appendChild(link);
            });
          }
          navHistoryContainer.appendChild(fragment);
          if (window.lucide) lucide.createIcons({ root: navHistoryContainer, nameAttr: 'data-lucide' });

        } catch (err) {
          if (err.name === 'AbortError') return;
          console.error('Nav search error:', err);
          navHistoryContainer.innerHTML = `<div class="nav-history-item"><div class="nav-history-item-info">Error fetching results</div></div>`;
        }
      };

      // Input Listener
      navSearchInput.addEventListener('input', () => {
        clearTimeout(navTypingTimer);
        const query = navSearchInput.value.trim();

        if (query.length > 1) {
          navResultsBox.style.display = 'block';
          navSearchForm.classList.add('results-open');
          navSearchForm.style.borderRadius = '15px 15px 0 0';
          
          // Show skeleton immediately while waiting for debounce
          navHistoryContainer.innerHTML = `<div class="nav-search-history-title">Searching...</div>${skeletonHTML}`;
          
          navTypingTimer = setTimeout(() => fetchNavResults(query), navDebounceDelay);
        } else {
          navResultsBox.style.display = 'none';
          navSearchForm.classList.remove('results-open');
          navSearchForm.style.borderRadius = '15px';
          if (currentController) currentController.abort();
        }
      });

      // Focus Listener
      navSearchInput.addEventListener('focus', () => {
        if (navSearchInput.value.trim().length > 1) {
          navResultsBox.style.display = 'block';
          navSearchForm.classList.add('results-open');
          navSearchForm.style.borderRadius = '15px 15px 0 0';
        }
      });
    }

    // --- E. UNIFIED GLOBAL CLICK LISTENER---
    // 
    // Handles closing Notifications, Dropdowns, and Search Results in one go
    document.addEventListener('click', (event) => {
    const target = event.target;

    // 1. Close Notifications
    const notifBox = document.getElementById('notificationBox');
    
    // FIXED LOGIC:
    // Check if the clicked target is the box OR if it is a button meant to toggle notifications
    // We check triggers by looking for the onclick attribute or the .notif-btn class
    const isTrigger = target.closest('[onclick="toggleNotifications()"]') || target.closest('.notif-btn');

    if (notifBox && notifBox.classList.contains('active')) {
      // If click is NOT inside the box AND NOT on a trigger button, close it
      if (!notifBox.contains(target) && !isTrigger) {
        notifBox.classList.remove('active');
      }
    }

      // 2. Close Dropdown
      if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) {
        if (!dropdownMenu.contains(target) && (!dropdownButton || !dropdownButton.contains(target))) {
          dropdownMenu.classList.add('hidden');
        }
      }

      // 3. Close Search Results
      if (navSearchForm && navResultsBox && navResultsBox.style.display === 'block') {
        if (!navSearchForm.contains(target)) {
          navResultsBox.style.display = 'none';
          navSearchForm.classList.remove('results-open');
          navSearchForm.style.borderRadius = '15px';
        }
      }
    });

    // --- F. INITIALIZE ICONS ---
    if (typeof lucide !== 'undefined') lucide.createIcons();

  });
</script>

</body>

</html>