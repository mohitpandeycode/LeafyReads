<!DOCTYPE html>
<html lang="en">
  {% load static %}
  {% load socialaccount %}

  <!-- loginpage -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="LeafyReads - read, search, and explore books online with a fast and smooth experience." />

    <title>Book</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="{% static 'css/book.css' %}" />
    <link rel="stylesheet" href="{% static 'css/searchnav.css' %}" />
    <link rel="stylesheet" href="{% static 'css/login.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark-dimmed.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    
  <style>
    body {
      background-image: url('{% static "images/backk.jpg" %}');
      width: 100%;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      background-attachment: fixed;
    }
    body.dark-mode {
  background-image: url('{% static "images/backdark1.png" %}');
}

    .nav-history-item{
      display: flex;
      align-items: center;
      color: inherit !important;
      margin-bottom: 8px;
      gap: 10px;
      padding-left: 10px;
      font-size: 13px;
    }
    .nav-history-item:hover{
      background-color: #7c7c7c18;
      border-radius: 5px;
    }
    .nav-search-history-title{
      margin-bottom: 8px;
      padding: 5px 0 5px 8px;
      color: inherit;
      font-size: 12px;
    }
    .nav-results{
      position: absolute;
      right: 0;
      width: 274px;
      background: rgb(255, 255, 255);
      top: 39px;
      border-radius: 0 0 15px 15px;
      display:none;
    }
    body.dark-mode .nav-results{
      background: rgb(59, 59, 59);
    }

    
  </style>
    <script src="{% static 'js/loading.js' %}"></script>
    <!-- Full version, works with turn.js -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  </head>

  <body>
    {% if messages %}
      <div class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start" role="alert">
        <div class="error__icon mr-3">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
            <path fill-rule="evenodd" d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="error__title grow">
          <ul style="padding:0px 14px;" class="messages">
            {% for message in messages %}
              <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
        <div class="error__close ml-4 cursor-pointer">
          <!-- Close Icon -->
          <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="text-gray-700 hover:text-gray-900 transition-colors">
            <path d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z"></path>
          </svg>
        </div>
      </div>
    {% endif %}
    <!-- Login Model -->
    <section class="loginpagesection" id="loginSection">
      <div class="leafy-auth-container" style="width: 380px;" id="loginContainer">
        <button class="close-btn" id="closelogin">&times;</button>
        <div class="login-logo" style="display: flex; align-items: center; justify-content: center;">
        <!-- common small logo -->
        <img style="width: 60px; border-radius: 15px;" src="{% static 'images/logo1.png' %}" loading="lazy" alt="">
        <!-- light theme image -->
        <img class="login-leafy-light" style="width: 140px; border-radius: 15px;" src="{% static 'images/leafylight.png' %}" loading="lazy" alt="">
        <!-- dark theme image -->
        <img class="login-leafy-dark" style="width: 140px; border-radius: 15px;" src="{% static 'images/leafyDark.png' %}" loading="lazy" alt="">
      </div>
        <h3 style="margin: 0;">Create Your Account</h3>
        <div class="leafy-sub-text">
          Already have an account? <a href="/" style="color:#4e8ef7;">Sign in</a>
        </div>
        <img style="width: 100%; height:25vh;" src="{% static 'images/login.gif' %}" loading="lazy" alt="Funny loading GIF" />

        <a style="width: 94%;" href="{% provider_login_url 'google' %}?next={{ request.path }}" class="leafy-auth-button google">
          <img src="https://cdn-icons-png.flaticon.com/512/281/281764.png" loading="lazy" alt="Google icon" />
          Continue with Google
        </a>

        <button class="leafy-auth-button github">
          <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" loading="lazy" alt="GitHub icon" />
          Sign in with GitHub
        </button>

        <button class="leafy-auth-button apple">
          <img src="https://cdn-icons-png.flaticon.com/512/0/747.png" loading="lazy" alt="Apple icon" />
          Sign in with Apple
        </button>

        <div class="leafy-terms">
          By clicking "signup" you agree to our <a href="#">Terms of Service</a> & <a href="#">Privacy Policy</a>.
        </div>

        <div class="leafy-explore">
          Continue without signup? <a href="/">explore</a>
        </div>
      </div>
    </section>

    <div id="loader-overlay" style="display:flex;flex-direction: column;">
      <img style="width: 100px;" src="{% static 'images/Book.gif' %}" alt="Loading..." />
      <h4>Unfolding stories, please wait...</h4>
    </div>
    <header class="co-header">
      <div class="co-container">
        <div class="co-header-content">
          <a href="/" class="logo">
            <!-- common logo part -->
            <img class="logo-icon" style="width: 48px; border-radius: 15px;" src="{% static 'images/logo1.png' %}" alt="">
            <!-- light theme image -->
            <img class="logo-light" style="width: 140px; border-radius: 15px;" src="{% static 'images/leafylight.png' %}" alt="">
            <!-- dark theme image -->
            <img class="logo-dark" style="width: 140px; border-radius: 15px;" src="{% static 'images/leafyDark.png' %}" alt="">
          </a>

          <nav class="co-desktop-nav" style="position: relative;">
            <a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a>
            <a href="{% url 'library' %}" class="{% if request.path == '/book/library/' %}active{% endif %}">Library</a>
            {% if user.is_authenticated %}
            <div style="position: relative;position: relative;display: flex;justify-content: center;align-items: center;">
              <a href="{% url 'myBooks' %}" class="{% if request.path == '/book/my-books/' %}active{% endif %}">Read Later</a>
              <p class="dot"></p>
            </div>
            {% endif %}
            <a href="{% url 'community' %}" class="{% if request.path == '/community/' %}active{% endif %}">Community</a>
            <a href="{% url 'aboutUs' %}" class="{% if request.path == '/aboutus/' %}active{% endif %}">About Us</a>
            <form id="navSearch" class="nav-search-wrapper" action="{% url 'searchbooks' %}" method="get">
              <div id="navSearchBtn" class="nav-search-button" aria-label="Search">
                <i data-lucide="search"></i>
              </div>
              <input type="text" name="q" id="navSearchInput" class="nav-search-input" placeholder="Search for books, authors, or genres..." />
              <button type="submit" id="sctive" style="display: none;border: none; background: #149546;border-radius: 8px;color: white;padding: 5px;cursor:pointer;"><span>Search</span></button>
            </form>
            <div class="nav-results">
              <div class="nav-search-history"></div>
            </div>
          </nav>
          <div class="co-header-actions">
            {% if user.is_authenticated %}
              <div class="dropdown">
                <button id="dropdown-button" class="btn">Welcome {{ user.first_name }} <i data-lucide="arrow-big-down-dash"></i></button>

                <ul id="dropdown-menu" class="dropdown-menu hidden">
                   {% if user.is_staff %}                  
                    <a href="/admin-dashboard/">
                    <li class="dropdown-item">
                      <i data-lucide="shield-check"></i>
                      <span>Admin Pannel</span>
                    </li>
                    </a>
                    {% else %}
                    <a href="{% url 'profilepage' %}">
                      <li class="dropdown-item">
                        <i data-lucide="user-pen"></i>
                        <span>Profile</span>
                      </li>
                    </a>
                    <li class="dropdown-item">
                      <i data-lucide="gem"></i>
                      <span>Go Pro</span>
                    </li>
                    <li class="dropdown-item">
                      <i data-lucide="credit-card"></i>
                      <span>Billing & Plans</span>
                    </li>
                    <li class="dropdown-item">
                      <i data-lucide="circle-question-mark"></i>
                      <span>Get Help</span>
                    </li>
                  {% endif %}
                    <li class="separator"></li>
                    <a href="{% url 'logout' %}">
                      <li class="dropdown-item">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                      </li>
                    </a>
                </ul>
              </div>
            {% else %}
              <div style="display: flex;align-items: center;justify-content: center;gap: 4px;" id="startlogin" class="btn primary-btn"><span>Start Reading Now </span><i style="width: 20px;" data-lucide="sparkles"></i></div>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <div class="actionbtns">
      <div id="myAlert" class="alert-container">
        <span class="alert-message">Tip : Press "F" for batter expirence.</span>
        <button class="alert-close-btn" aria-label="Close alert">
          <svg viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>
      <div>
        <button id="fullscreenBtn" class="control-button fullscreen-button" title="Fullscreen mode">‚õ∂</button>
        <button id="darkModeBtn" class="control-button fullscreen-button" style="top: 130px; padding: 8px" title="Dark Mode">üåô</button>
        <button disabled id="play" class="control-button fullscreen-button" style="top: 180px; padding: 10px 10px 5px 10px;" title="listen book"><i data-lucide="play"></i></button>
        <button id="highlightBtn" class="control-button fullscreen-button" style="top: 230px; padding: 8px" title="Highlighter">üñçÔ∏è</button>
        <button id="shortcutsBtn" class="control-button fullscreen-button" style="top: 280px; padding: 8px" title="Keyboard Shortcuts">‚å®Ô∏è</button>
        <button id="muteBtn" class="control-button fullscreen-button" style="top: 330px; padding: 8px" title="Mute/Unmute Audio">üîä</button>
        {% if user.is_authenticated %}
          <button id="likeBtn" class="control-button fullscreen-button {% if liked %}like-active{% endif %}" style="top: 530px; padding: 8px;" title="Like" data-url="{% url 'toggle_like' book.slug %}"><i data-lucide="thumbs-up"></i></button>
          <button id="saveBtn" class="control-button fullscreen-button {% if saved %}save-active{% endif %}" style="top: 580px; padding: 8px;" title="Save" data-url="{% url 'toggle_read_later' book.slug %}"><i data-lucide="bookmark"></i></button>
          <a href="{% url 'community' %}" id="comment" class="control-button fullscreen-button" style="top: 630px; padding: 8px" title="community"><i data-lucide="messages-square"></i></a>
        {% endif %}
        <div id="toast-notification" class="toast">
          <span id="toast-message"></span>
        </div>
      </div>
    </div>

    <!-- Main Book -->
    <main id="container-wrapper">
      <button id="prevBtn" class="nav-button prev" style="display: none;" aria-label="Previous"><span class="icon">&larr;</span></button>

      <section id="container">
        <div id="spine-illusion" hidden></div>

        <div class="flipbook">
          <article class="page hard cover" style="border: 1px double white;">
            <img src="{% static 'images/framebook1.png' %}" loading="lazy" class="cover-image" style="position: absolute;    left: -2px;width: 101%;top: -2px;height: 101%;" alt="forntFrame" />
            <img src="{{ book.cover_front.url }}?q_auto,f_auto" loading="lazy" style="object-fit: cover;" alt="Cover Image" class="cover-image" />
            <div class="bookinfocover">
              <h4 style="margin: 0;">{{book.title}}</h4>
              <p style="font-size:16px;margin: 0;">By: {{book.author}}</p>
            </div>
          </article>

          <article class="page">
            <div class="pagestyle">
              {{ bookcontent|safe }}
              <!--  {% for paragraph in bookcontent.splitlines %}
                <p>{{ paragraph|safe }}</p>
              {% endfor %}  -->
            </div>
          </article>
        </div>
      </section>

      <button id="nextBtn" class="nav-button next" style="display: none;" aria-label="Next"><span class="icon">&rarr;</span></button>
      <div id="progress-bar-container" aria-label="Page Progress">
        <div id="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      </div>
    </main>

    <audio id="flipForward" src="{% static 'sounds/flip1.mp3' %}" preload="auto" aria-hidden="true"></audio>
    <audio id="flipBackward" src="{% static 'sounds/flip2.mp3' %}" preload="auto" aria-hidden="true"></audio>
    <div id="shortcutsPanel" class="shortcuts-panel">
      <div class="shortcuts-header">
        <h2>Keyboard Shortcuts</h2>
        <button id="closeShortcuts" aria-label="Close Shortcuts Panel">‚úñÔ∏è</button>
      </div>
      <ul>
        <li>
          <b>( ·ñ¥ )</b> ‚òõ Fullscreen Mode
        </li>
        <li>
          <b>( D )</b> ‚òõ Dark Mode/Light Mode
        </li>
        <li>
          <b>( M )</b> ‚òõ Mute/Unmute
        </li>
        <li>
          <b>( H )</b> ‚òõ Highlighter Pen
        </li>
        <li>
          <b>(‚û°Ô∏è)</b> ‚òõ Next Page
        </li>
        <li>
          <b>(‚¨ÖÔ∏è)</b> ‚òõ Previous Page
        </li>
      </ul>
    </div>
    <script src="{% static 'js/turn.min.js' %}" defer></script>
    <script src="{% static 'js/highlight.js' %}"></script>
    <script src="{% static 'js/book.js' %}"></script>
    <script src="{% static 'js/pagination.js' %}"></script>
    <script src="{% static 'js/navsearch.js' %}"></script>
    {% if book.audio_file %}
    <script>
  // Audio Play/Pause Logic
  let audioFile = new Audio('{{ book.audio_file.url }}');
  const playBtn = document.getElementById('play');

  if (playBtn) {
    playBtn.addEventListener('click', () => {
      if (audioFile.paused) {
        audioFile.play();
        playBtn.innerHTML = '<i data-lucide="pause"></i>';
      } else {
        audioFile.pause();
        playBtn.innerHTML = '<i data-lucide="play"></i>';
      }
      lucide.createIcons();
    });
  }
</script>
{% endif %}

<script>
  const clicks = new Audio('/static/sounds/click.mp3');

  document.addEventListener('DOMContentLoaded', () => {
    const likeBtn = document.getElementById('likeBtn');
    const saveBtn = document.getElementById('saveBtn');
    const dot = document.querySelector('.dot');
    const toast = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');

    function showToast(message) {
      toastMessage.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Burst Likes Animation
    function burstLikes(count = 30) {
      let i = 0;
      const interval = setInterval(() => {
        if (i >= count) return clearInterval(interval);
        requestAnimationFrame(() => {
          const like = document.createElement('div');
          like.classList.add('like');
          like.textContent = 'üëç';
          const size = Math.random() * 16 + 16;
          like.style.cssText = `
            font-size: ${size}px;
            left: ${Math.random() * window.innerWidth}px;
            animation-duration: ${Math.random() * 2 + 2}s;
          `;
          document.body.appendChild(like);
          setTimeout(() => like.remove(), 4000);
        });
        i++;
      }, 20);
    }

    // AJAX for Save / Read Later (Optimistic)
    if (saveBtn) {
      saveBtn.addEventListener('click', function() {
        const url = this.dataset.url;
        const csrfToken = '{{ csrf_token }}';

        // --- Optimistic UI Update ---
        const isSaving = !this.classList.contains('save-active');
        this.classList.toggle('save-active'); // Toggle UI immediately
        clicks.currentTime = 0;
        clicks.play();

        if (isSaving) {
          showToast('Added to Read Later');
          if(dot) dot.style.display = "block";
        } else {
          showToast('Removed from Read Later');
          if(dot) dot.style.display = "none";
        }
        // --- End Optimistic UI ---

        fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        })
        .then(response => response.json())
        .then(data => {
          if (data.status !== 'saved' && data.status !== 'removed') {
            // ERROR: Revert UI
            showToast(data.message || 'An error occurred.');
            this.classList.toggle('save-active'); // Revert toggle
            if(dot) dot.style.display = isSaving ? "none" : "block"; // Revert dot
          } else {
            // Server confirmed, just update the message
            showToast(data.message);
          }
        })
        .catch(error => {
          // NETWORK ERROR: Revert UI
          console.error('Error:', error);
          showToast('Something went wrong. Please try again.');
          this.classList.toggle('save-active'); // Revert toggle
          if(dot) dot.style.display = isSaving ? "none" : "block"; // Revert dot
        });
      });
    }

    // AJAX for Like Button (Optimistic)
    if (likeBtn) {
      likeBtn.addEventListener('click', function() {
        const url = this.dataset.url;
        const csrfToken = '{{ csrf_token }}';

        // --- Optimistic UI Update ---
        const isLiking = !this.classList.contains('like-active');
        this.classList.toggle('like-active'); // Toggle UI immediately
        clicks.currentTime = 0;
        clicks.play();
        
        if (isLiking) {
          showToast('Liked!');
          burstLikes(30); // Only burst when liking
        } else {
          showToast('Unliked');
        }
        // --- End Optimistic UI ---

        fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        })
        .then(response => response.json())
        .then(data => {
          if (data.status !== 'liked' && data.status !== 'unliked') {
            // ERROR: Revert UI
            showToast(data.message || 'An error occurred.');
            this.classList.toggle('like-active'); // Revert toggle
          } else {
            // Server confirmed, just update the message
            showToast(data.message);
          }
        })
        .catch(error => {
          // NETWORK ERROR: Revert UI
          console.error('Error:', error);
          showToast('Something went wrong. Please try again.');
          this.classList.toggle('like-active'); // Revert toggle
        });
      });
    }

    // Login Modal Toggle
    const startlogin = document.getElementById('startlogin');
    const loginSection = document.getElementById('loginSection');
    const closelogin = document.getElementById('closelogin');

    if (startlogin && loginSection && closelogin) {
      startlogin.addEventListener('click', () => loginSection.classList.add('active'));
      closelogin.addEventListener('click', () => loginSection.classList.remove('active'));
      loginSection.addEventListener('click', (e) => {
        if (e.target === loginSection) loginSection.classList.remove('active');
      });
    }

    // alert Fade-Out
    const errorDiv = document.querySelector('.error');
    if (errorDiv) {
      const closeButton = errorDiv.querySelector('.error__close');
      const hideError = () => {
        errorDiv.classList.add('fade-out');
        const onAnimationEnd = () => {
          errorDiv.remove();
          errorDiv.removeEventListener('animationend', onAnimationEnd);
        };
        errorDiv.addEventListener('animationend', onAnimationEnd);
      };
      const timer = setTimeout(hideError, 3000);
      if (closeButton) closeButton.addEventListener('click', () => {
        clearTimeout(timer);
        hideError();
      });
    }

    // User Dropdown Menu
    const dropdownButton = document.getElementById('dropdown-button');
    const dropdownMenu = document.getElementById('dropdown-menu');

    if (dropdownButton && dropdownMenu) {
      dropdownButton.addEventListener('click', (event) => {
        event.stopPropagation();
        dropdownMenu.classList.toggle('hidden');
      });

      window.addEventListener('click', (event) => {
        if (!dropdownMenu.contains(event.target) && !dropdownButton.contains(event.target)) {
          dropdownMenu.classList.add('hidden');
        }
      });
    }

    // Initialize Lucide Icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });
</script>

<!-- searchbar -->
<script>
      ; (function () {
        'use strict'

        // Tracks the current active request for cancellation (prevents race conditions)
        let currentController = null;

        document.addEventListener('DOMContentLoaded', () => {
          // --- Nav Search Bar AJAX ---
          const navSearchForm = document.getElementById('navSearch')
          const navSearchInput = document.getElementById('navSearchInput')
          const navResultsBox = document.querySelector('.nav-results')
          const navHistoryContainer = navResultsBox ? navResultsBox.querySelector('.nav-search-history') : null

          if (navSearchInput && navResultsBox && navHistoryContainer && navSearchForm) {

            const fetchNavResults = async (query) => {

              // Cancel the previous running request
              if (currentController) currentController.abort();
              currentController = new AbortController();

              // Show immediate Loading State
              navHistoryContainer.innerHTML = `
                    <div class="nav-search-history-title">Search results</div>
                    <div class="nav-history-item loading-state">
                        <i data-lucide="loader" class="animate-spin"></i>
                        <div class="nav-history-item-info">
                            <span class="nav-history-item-title">Searching...</span>
                        </div>
                    </div>
                `;
              navResultsBox.style.display = 'block';
              navSearchForm.classList.add('results-open');
              navSearchForm.style.borderRadius = '15px 15px 0 0';


              try {
                const response = await fetch(`/book/ajax/search/?q=${encodeURIComponent(query)}`, {
                  signal: currentController.signal
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                const results = data.results;

                // Render results
                navHistoryContainer.innerHTML = '';
                const fragment = document.createDocumentFragment();

                const titleEl = document.createElement('div');
                titleEl.className = 'nav-search-history-title';
                titleEl.textContent = 'Search results';
                fragment.appendChild(titleEl);

                if (!results.length) {
                  const noResultEl = document.createElement('div');
                  noResultEl.className = 'nav-history-item';
                  noResultEl.innerHTML = `<i data-lucide="search"></i>
                            <div class="nav-history-item-info">
                                <span class="nav-history-item-title">No results found</span>
                            </div>`;
                  fragment.appendChild(noResultEl);
                } else {
                  results.forEach((book) => {
                    const link = document.createElement('a');
                    link.href = `/book/library/open/${book.slug}`;
                    link.className = 'nav-history-item';

                    const icon = document.createElement('i')
                    icon.setAttribute('data-lucide', 'search')

                    const infoDiv = document.createElement('div')
                    infoDiv.className = 'nav-history-item-info'

                    const titleSpan = document.createElement('span')
                    titleSpan.className = 'nav-history-item-title'
                    titleSpan.textContent = book.title || 'Untitled'

                    const authorSpan = document.createElement('span')
                    authorSpan.className = 'nav-history-item-author'
                    authorSpan.textContent = ` by ${book.author || 'Unknown Author'}`

                    infoDiv.appendChild(titleSpan)
                    infoDiv.appendChild(authorSpan)
                    link.appendChild(icon)
                    link.appendChild(infoDiv)
                    fragment.appendChild(link)
                  });
                }
                navHistoryContainer.appendChild(fragment);
                if (window.lucide) lucide.createIcons();

              } catch (err) {
                // Ignore AbortError: request was cancelled by user typing faster
                if (err.name === 'AbortError') return;

                console.error('Nav search error:', err);
                navHistoryContainer.innerHTML = `<div class="nav-search-history-title">Search results</div><div class="nav-history-item"><div class="nav-history-item-info"><span class="nav-history-item-title">Error fetching results</span></div></div>`;
                if (window.lucide) lucide.createIcons();
              }
            }

            // --- DEBOUNCE & INPUT LISTENER ---
            let navTypingTimer;
            const navDebounceDelay = 300;

            navSearchInput.addEventListener('input', () => {
              clearTimeout(navTypingTimer);
              const query = navSearchInput.value.trim();

              if (query.length > 2) {
                navTypingTimer = setTimeout(() => fetchNavResults(query), navDebounceDelay);

              } else {
                // Hide the box if the query is too short
                navResultsBox.style.display = 'none';
                navSearchForm.classList.remove('results-open');
                navSearchForm.style.borderRadius = '15px';
                // Cancel any pending fetch when search bar is cleared
                if (currentController) currentController.abort();
              }
            });

            // --- OUTSIDE CLICK & FOCUS LISTENERS ---
            document.addEventListener('click', (e) => {
              if (!navSearchForm.contains(e.target)) {
                navResultsBox.style.display = 'none';
                navSearchForm.classList.remove('results-open');
              }
            });

            navSearchInput.addEventListener('focus', () => {
              const query = navSearchInput.value.trim();
              if (query.length > 2) {
                navResultsBox.style.display = 'block';
                fetchNavResults(query);
              }
            });
          }
        });
      })();
  </script>

  </body>
</html>
