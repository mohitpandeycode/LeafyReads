<!DOCTYPE html>
<html lang="en">
  {% load static %}
  {% load socialaccount %}
  {% load cloudinary_filters %}
{% load cloudinary %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Read {{ title }} by {{ book.author }} online. {{ bookcontent|truncatewords:25 }}" />
    <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=96 height=96 crop='scale' %}" sizes="96x96" type="image/png">
    <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=48 height=48 crop='scale' %}" sizes="48x48" type="image/png">
    <link rel="apple-touch-icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=180 height=180 crop='scale' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="canonical" href="{{ request.build_absolute_uri }}" />
    <title>{{ title }} - By {{ book.author }} | LeafyReads</title>
    <meta property="og:type" content="book" />
    <meta property="og:title" content="{{ title }} - By {{ book.author }}" />
    <meta property="og:description" content="Read {{ title }} online at LeafyReads." />
    <meta property="og:image" content="{{ book.cover_front.url }}" /> <meta property="og:url" content="{{ request.build_absolute_uri }}" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="{% static 'css/book.css' %}" />
    <link rel="stylesheet" href="{% static 'css/searchnav.css' %}" />
    <link rel="stylesheet" href="{% static 'css/login.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark-dimmed.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    
  <style>
    body {
      background-image: url('{% cloudinary_url "wyufreqgjewhquxqfz3e" %}');
      width: 100%;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      background-attachment: fixed;
    }
    body.dark-mode {
      background-image: url('{% cloudinary_url "ykzhhhzo80g9lxu1g5vk" %}');
}

    .nav-history-item{
      display: flex;
      align-items: center;
      color: inherit !important;
      margin-bottom: 8px;
      gap: 10px;
      padding-left: 10px;
      font-size: 13px;
    }
    .nav-history-item:hover{
      background-color: #7c7c7c18;
      border-radius: 5px;
    }
    .nav-search-history-title{
      margin-bottom: 8px;
      padding: 5px 0 5px 8px;
      color: inherit;
      font-size: 12px;
    }
    .nav-results{
      position: absolute;
      right: 0;
      width: 274px;
      background: rgb(255, 255, 255);
      top: 39px;
      border-radius: 0 0 15px 15px;
      display:none;
    }
    body.dark-mode .nav-results{
      background: rgb(59, 59, 59);
    }

    
  </style>
    <script src="{% static 'js/loading.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    {% include 'book_detail.html' %}
  </head>

  <body>
    {% if messages %}
      <div class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start" role="alert">
        <div class="error__icon mr-3">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
            <path fill-rule="evenodd" d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="error__title grow">
          <ul style="padding:0px 14px;" class="messages">
            {% for message in messages %}
              <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
        <div class="error__close ml-4 cursor-pointer">
          <!-- Close Icon -->
          <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="text-gray-700 hover:text-gray-900 transition-colors">
            <path d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z"></path>
          </svg>
        </div>
      </div>
    {% endif %}
    <!-- Login Model -->
    <section class="loginpagesection" id="loginSection">
      <div class="leafy-auth-container" style="width: 380px;" id="loginContainer">
        <button class="close-btn" id="closelogin">&times;</button>
        <div class="login-logo" style="display: flex; align-items: center; justify-content: center;">
        <!-- common small logo -->
        {% cloudinary "qqeschqzlywacz6rqsbl" quality="auto" fetch_format="auto" style="width: 60px; border-radius: 15px;" loading="lazy" alt="logo" %}
      {% cloudinary "tdehybbsyciqodgxs2rq" quality="auto" fetch_format="auto" class="login-leafy-light" style="width: 140px; border-radius: 15px;" loading="lazy" alt="LeafyReads" %}
      {% cloudinary "kp6b6xlwuu8d52cfhfba" quality="auto" fetch_format="auto" class="login-leafy-dark" style="width: 140px; border-radius: 15px;" loading="lazy" alt="LafyReads" %}
      </div>
        <h3 style="margin: 0;">Create Your Account</h3>
        <div class="leafy-sub-text">
          Already have an account? <a href="/" style="color:#4e8ef7;">Sign in</a>
        </div>
        {% cloudinary "ht4lblz4fxlllxlbw5sa" width=400 crop="scale" quality="auto" fetch_format="auto" flags="lossy" style="width: 100%; height:25vh;" loading="lazy" alt="Funny loading GIF" %}

        <a style="width: 94%;" href="{% provider_login_url 'google' %}?next={{ request.path }}" class="leafy-auth-button google">
          <img src="https://cdn-icons-png.flaticon.com/512/281/281764.png" loading="lazy" alt="Google icon" />
          Continue with Google
        </a>

        <a href="{% provider_login_url 'facebook' method='oauth2' %}" style="background: #08446f;color: white;width: 94%;" class="leafy-auth-button facebook">
          <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" loading="lazy" alt="Facebook icon" />
          Sign in with Facebook
        </a>

        <button class="leafy-auth-button apple">
          <img src="https://cdn-icons-png.flaticon.com/512/0/747.png" loading="lazy" alt="Apple icon" />
          Sign in with Apple
        </button>

        <div class="leafy-terms">
          By clicking "signup" you agree to our <a href="{% url 'terms-of-service' %}">Terms of Service</a> & <a href="{% url 'privacy-policy' %}">Privacy Policy</a>.
        </div>

        <div class="leafy-explore">
          Continue without signup? <a href="/">explore</a>
        </div>
      </div>
    </section>

    <div id="loader-overlay" style="display:flex;flex-direction: column;">
      <img style="width: 100px;" src="{% static 'images/Book.gif' %}" alt="Loading..." />
      <h4>Unfolding stories, please wait...</h4>
    </div>
    <header class="co-header">
      <div class="co-container">
        <div class="co-header-content">
          <a href="/" class="logo">
            <!-- common logo part -->
            {% cloudinary "qqeschqzlywacz6rqsbl" class="logo-icon" style="width: 48px; border-radius: 15px;" alt="logo" %}
            {% cloudinary "tdehybbsyciqodgxs2rq" class="logo-light" style="width: 140px; border-radius: 15px;" alt="LeafyReads" %}
            {% cloudinary "kp6b6xlwuu8d52cfhfba" class="logo-dark" style="width: 140px; border-radius: 15px;" alt="LeafyReads" %}
          </a>

          <nav class="co-desktop-nav" style="position: relative;">
            <a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a>
            <a href="{% url 'library' %}" class="{% if request.path == '/book/library/' %}active{% endif %}">Library</a>
            {% if user.is_authenticated %}
            <div style="position: relative;position: relative;display: flex;justify-content: center;align-items: center;">
              <a href="{% url 'myBooks' %}" class="{% if request.path == '/book/my-books/' %}active{% endif %}">Read Later</a>
              <p class="dot"></p>
            </div>
            {% endif %}
            <a href="{% url 'community' %}" class="{% if request.path == '/community/' %}active{% endif %}">Community</a>
            <a href="{% url 'aboutUs' %}" class="{% if request.path == '/aboutus/' %}active{% endif %}">About Us</a>
            <form id="navSearch" class="nav-search-wrapper" action="{% url 'searchbooks' %}" method="get">
              <div id="navSearchBtn" class="nav-search-button" aria-label="Search">
                <i data-lucide="search"></i>
              </div>
              <input type="text" name="q" id="navSearchInput" class="nav-search-input" placeholder="Search for books, authors, or genres..." />
              <button type="submit" id="sctive" style="display: none;border: none; background: #149546;border-radius: 8px;color: white;padding: 5px;cursor:pointer;"><span>Search</span></button>
            </form>
            <div class="nav-results">
              <div class="nav-search-history"></div>
            </div>
          </nav>
          <div class="co-header-actions">
            <!-- Notification Pannel -->
          {% if user.is_authenticated %}
          <div class="notification-wrapper" style="position: relative; display: inline-block;">
            <button style="position: relative;" onclick="toggleNotifications()" aria-label="notification"
              class="notif-btn theme-toggle-btn"><i data-lucide="bell"></i>
              <p class="notify-dot"></p>
            </button>
            <div class="notification-box glass-panel" id="notificationBox">
              <div class="notif-header">
                <h3>Notifications</h3>
                <button class="mark-read-text">Mark all read</button>
              </div>

              <div class="notif-list">
                {% if notifications %}
                {% for notif in notifications %}

                {% if notif.notification_type == 'post_delete' %}
                <div class="notif-item" style="cursor: default;">
                  <div class="notif-icon-box bg-teal">
                    üóëÔ∏è
                  </div>
                  <div class="notif-content">
                    <p>{{ notif.message|safe }}</p>
                    <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
                  </div>
                </div>
                {% else %}
                <a href="{% url 'post_view' notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
                  <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
                    <div class="notif-icon-box bg-teal">
                      {% if notif.notification_type == 'like' %}‚ù§Ô∏è
                      {% elif notif.notification_type == 'comment' %}üí¨
                      {% elif notif.notification_type == 'book_mention' %}üìö
                      {% else %}üîî{% endif %}
                    </div>
                    <div class="notif-content">
                      <p>{{ notif.message|safe }}</p>
                      <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
                    </div>
                    {% if not notif.is_read %}
                    <div class="unread-dot"></div>
                    {% endif %}
                  </div>
                </a>
                {% endif %}

                {% endfor %}
                {% else %}
                <div style="padding: 1.5rem; text-align: center; color: #94a3b8; font-size: 0.85rem;">
                  <p>No new updates</p>
                </div>
                {% endif %}

                <div class="notif-item">
                  <div class="notif-icon-box bg-teal">
                    <i data-lucide="sparkles"></i>
                  </div>
                  <div class="notif-content">
                    <p><strong>Welcome to LeafyReads!</strong> üåø Discover new books...</p>
                    <span class="notif-time">{{ user.date_joined|timesince }} ago</span>
                  </div>
                </div>
              </div>
              <div class="notif-footer">
                <a href="#">View All History</a>
              </div>
            </div>
          </div>
          {% endif %}
            {% if user.is_authenticated %}
              <div class="dropdown">
                <button id="dropdown-button" class="btn">Welcome {{ user.first_name }} <i data-lucide="arrow-big-down-dash"></i></button>

                <ul id="dropdown-menu" class="dropdown-menu hidden">
                   {% if user.is_staff %}                  
                    <a href="/admin-dashboard/">
                    <li class="dropdown-item">
                      <i data-lucide="shield-check"></i>
                      <span>Admin Pannel</span>
                    </li>
                    </a>
                    {% else %}
                    <a href="{% url 'profilepage' %}">
                      <li class="dropdown-item">
                        <i data-lucide="user-pen"></i>
                        <span>Profile</span>
                      </li>
                    </a>
                    <li class="dropdown-item">
                      <i data-lucide="gem"></i>
                      <span>Go Pro</span>
                    </li>
                    <li class="dropdown-item">
                      <i data-lucide="circle-question-mark"></i>
                      <span>Get Help</span>
                    </li>
                  {% endif %}
                    <li class="separator"></li>
                    <a href="{% url 'logout' %}">
                      <li class="dropdown-item">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                      </li>
                    </a>
                </ul>
              </div>
            {% else %}
              <div style="display: flex;align-items: center;justify-content: center;gap: 4px;" id="startlogin" class="btn primary-btn"><span>Start Reading Now </span><i style="width: 20px;" data-lucide="sparkles"></i></div>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <div class="actionbtns">
      <div id="myAlert" class="alert-container">
        <span class="alert-message"><strong>Tip:</strong> Scroll mouse wheel to Zoom In/Out the Book!</span>
        <button class="alert-close-btn" aria-label="Close alert">
          <svg viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
        <div class="alert-progress"></div>
      </div>
      <div class="goto-page-box">
          <h6 class="pagesinfo">Loading...</h6>
            <input type="number" id="pageInput" placeholder="Page..." min="1" />
            <button id="goBtn">Go</button>
      </div>
      <div class="action-btn">
        <div class="nonsocialaction">
          <button id="fullscreenBtn" class="control-button fullscreen-button" title="Fullscreen mode">‚õ∂</button>
          <button id="darkModeBtn" class="control-button fullscreen-button" title="Dark Mode">üåô</button>
          <button disabled id="play" class="control-button fullscreen-button" title="listen book"><i data-lucide="play"></i></button>
          <a href="{% url 'pageView' book.slug %}" class="control-button fullscreen-button" title="Switch to Page View">üìú</a>   
          <button id="highlightBtn" class="control-button fullscreen-button" title="Highlighter">üñçÔ∏è</button>
          <button id="shortcutsBtn" class="control-button fullscreen-button" title="Keyboard Shortcuts">‚å®Ô∏è</button>
          <button id="muteBtn" class="control-button fullscreen-button" title="Mute/Unmute Audio">üîä</button>     
        </div>
        {% if user.is_authenticated %}
        <div class="socialaction">
            <button id="likeBtn" style="border: 2px solid #09a2ff" class="control-button fullscreen-button {% if liked %}like-active{% endif %}" title="Like" data-url="{% url 'toggle_like' book.slug %}"><i data-lucide="thumbs-up"></i></button>
            <button id="saveBtn" style="border: 2px solid #ff9209;" class="control-button fullscreen-button {% if saved %}save-active{% endif %}" title="Save" data-url="{% url 'toggle_read_later' book.slug %}"><i data-lucide="bookmark"></i></button>
            <a href="{% url 'community' %}" id="comment" class="control-button fullscreen-button" title="community"><i data-lucide="messages-square"></i></a>
        </div>
        {% endif %} 
        <div id="toast-notification" class="toast">
          <span id="toast-message"></span>
        </div>
      </div>
    </div>

    <!-- Main Book -->
    <main id="container-wrapper">
      <button id="prevBtn" class="nav-button prev" style="display: none;" aria-label="Previous"><span class="icon">&larr;</span></button>

      <section id="container">
        <div style="display:none;position: absolute;bottom: -30px;left: 0;" class="soundwave">
            {% cloudinary "jg32efxqxb4pt7efvegr" style="height: 65px;width: 100px;" quality="auto" fetch_format="auto" alt="soundwave" %}
        </div>
        <div id="spine-illusion" hidden></div>

        <div class="flipbook">
          <article class="page hard cover" style="border: 1px double white;">
            {% cloudinary "rpy7fckyfzgkmnftr6ln" loading="lazy" quality="auto" fetch_format="auto" class="cover-image" style="position: absolute; left: -2px; width: 101%; top: -2px; height: 101%;" alt="forntFrame" %}
            <img src="{{ book.cover_front.url }}?q_auto,f_auto" style="object-fit: cover;" alt="Cover Image" class="cover-image" />
            <div class="bookinfocover">
              <h5 style="margin: 0;">{{book.title}}</h5>
              <p style="font-size:16px;margin: 0;">By: {{book.author}}</p>
            </div>
          </article>

          <article class="page">
            <div class="pagestyle">
              {{ bookcontent|optimize_cloudinary_images|safe }}
            </div>
          </article>
        </div>
      </section>

      <button id="nextBtn" class="nav-button next" style="display: none;" aria-label="Next"><span class="icon">&rarr;</span></button>
      <div id="progress-bar-container" aria-label="Page Progress">
        <div id="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      </div>
      
    </main>

    <audio id="flipForward" src="{% static 'sounds/flip1.mp3' %}" preload="auto" aria-hidden="true"></audio>
    <audio id="flipBackward" src="{% static 'sounds/flip2.mp3' %}" preload="auto" aria-hidden="true"></audio>
    <div id="shortcutsPanel" class="shortcuts-panel">
      <div class="shortcuts-header">
        <h2>Keyboard Shortcuts</h2>
        <button id="closeShortcuts" aria-label="Close Shortcuts Panel">‚úñÔ∏è</button>
      </div>
      <ul>
        <li>
          <b>( ·ñ¥ )</b> ‚òõ Fullscreen Mode
        </li>
        <li>
          <b>( D )</b> ‚òõ Dark Mode/Light Mode
        </li>
        <li>
          <b>( M )</b> ‚òõ Mute/Unmute
        </li>
        <li>
          <b>( H )</b> ‚òõ Highlighter Pen
        </li>
        <li>
          <b>(‚û°Ô∏è)</b> ‚òõ Next Page
        </li>
        <li>
          <b>(‚¨ÖÔ∏è)</b> ‚òõ Previous Page
        </li>
      </ul>
    </div>
    <script src="{% static 'js/turn.min.js' %}" defer></script>
    <script src="{% static 'js/highlight.js' %}"></script>
    <script src="{% static 'js/book.js' %}"></script>
    <script src="{% static 'js/pagination.js' %}"></script>
    <script src="{% static 'js/loading.js' %}"></script>
    <script src="{% static 'js/navsearch.js' %}"></script>

<script>
  // --- 1. GLOBAL HELPER: UI SOUND ---
  const uiClickSound = new Audio('/static/sounds/click.mp3');
  window.playUiSound = function() {
    uiClickSound.currentTime = 0;
    uiClickSound.play().catch(e => { /* Ignore auto-play blocking */ });
  };

  // --- 2. GLOBAL HELPER: TOGGLE NOTIFICATIONS ---
  window.toggleNotifications = function() {
    window.playUiSound();
    const box = document.getElementById('notificationBox');
    if(box) box.classList.toggle('active');
  };

  // ==========================================
  //      MAIN EXECUTION (DOM Ready)
  // ==========================================
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- A. CONSTANTS & TOASTS ---
    const toast = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');
    const csrfToken = '{{ csrf_token }}';

    function showToast(message) {
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      } else {
        // Fallback if toast HTML isn't present
        console.log("Toast:", message);
      }
    }

    // --- B. AUDIO PLAYER MODULE ---
 
    const audioUrl = "{% if book.audio_file %}{{ book.audio_file.url }}{% endif %}";
    const playBtn = document.getElementById('play');
    const soundwave = document.querySelector('.soundwave');

    if (audioUrl && playBtn) {
      const audioFile = new Audio(audioUrl);
      
      playBtn.addEventListener('click', () => {
        window.playUiSound();
        if (audioFile.paused) {
          audioFile.play().then(() => {
            playBtn.innerHTML = '<i data-lucide="pause"></i>';
            if(soundwave) soundwave.style.display = "block";
            if(window.lucide) lucide.createIcons();
          }).catch(e => console.error("Audio Play Error:", e));
        } else {
          audioFile.pause();
          playBtn.innerHTML = '<i data-lucide="play"></i>';
          if(soundwave) soundwave.style.display = "none";
          if(window.lucide) lucide.createIcons();
        }
      });

      // Reset when audio finishes
      audioFile.addEventListener('ended', () => {
        playBtn.innerHTML = '<i data-lucide="play"></i>';
        if(soundwave) soundwave.style.display = "none";
        if(window.lucide) lucide.createIcons();
      });
    }

    // --- C. NOTIFICATION CLICK OUTSIDE ---
    document.addEventListener('click', function (event) {
      const box = document.getElementById('notificationBox');
      const btn = document.querySelector('.notif-btn');
      if (box && btn && !box.contains(event.target) && !btn.contains(event.target)) {
        box.classList.remove('active');
      }
    });

    // --- D. NAVIGATION SEARCH BAR (Ajax) ---
    const navSearchForm = document.getElementById('navSearch');
    const navSearchInput = document.getElementById('navSearchInput');
    const navResultsBox = document.querySelector('.nav-results');
    const navHistoryContainer = navResultsBox ? navResultsBox.querySelector('.nav-search-history') : null;
    let currentController = null; // For cancelling previous requests
    let navTypingTimer;

    if (navSearchInput && navResultsBox && navHistoryContainer && navSearchForm) {
        
        const fetchNavResults = async (query) => {
            if (currentController) currentController.abort();
            currentController = new AbortController();

            // Loading State
            navHistoryContainer.innerHTML = `
                <div class="nav-search-history-title">Search results</div>
                <div class="nav-history-item loading-state">
                    <i data-lucide="loader" class="animate-spin"></i>
                    <div class="nav-history-item-info"><span class="nav-history-item-title">Searching...</span></div>
                </div>`;
            navResultsBox.style.display = 'block';
            navSearchForm.classList.add('results-open');
            navSearchForm.style.borderRadius = '15px 15px 0 0';
            if(window.lucide) lucide.createIcons();

            try {
                const response = await fetch(`/book/ajax/search/?q=${encodeURIComponent(query)}`, {
                    signal: currentController.signal
                });
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                const results = data.results;

                navHistoryContainer.innerHTML = '';
                
                // Title
                const titleEl = document.createElement('div');
                titleEl.className = 'nav-search-history-title';
                titleEl.textContent = 'Search results';
                navHistoryContainer.appendChild(titleEl);

                if (!results.length) {
                    const noResultEl = document.createElement('div');
                    noResultEl.className = 'nav-history-item';
                    noResultEl.innerHTML = `<i data-lucide="search"></i>
                        <div class="nav-history-item-info"><span class="nav-history-item-title">No results found</span></div>`;
                    navHistoryContainer.appendChild(noResultEl);
                } else {
                    results.forEach((book) => {
                        const link = document.createElement('a');
                        link.href = `/book/library/book-details/${book.slug}`;
                        link.className = 'nav-history-item';
                        link.innerHTML = `
                            <i data-lucide="search"></i>
                            <div class="nav-history-item-info">
                                <span class="nav-history-item-title">${book.title || 'Untitled'}</span>
                                <span class="nav-history-item-author"> by ${book.author || 'Unknown'}</span>
                            </div>`;
                        navHistoryContainer.appendChild(link);
                    });
                }
                if(window.lucide) lucide.createIcons();

            } catch (err) {
                if (err.name === 'AbortError') return; // Ignore cancellations
                console.error('Nav search error:', err);
                navHistoryContainer.innerHTML = `<div class="nav-history-item"><div class="nav-history-item-info">Error fetching results</div></div>`;
            }
        };

        // Input Listener with Debounce
        navSearchInput.addEventListener('input', () => {
            clearTimeout(navTypingTimer);
            const query = navSearchInput.value.trim();
            if (query.length > 2) {
                navTypingTimer = setTimeout(() => fetchNavResults(query), 300);
            } else {
                navResultsBox.style.display = 'none';
                navSearchForm.classList.remove('results-open');
                navSearchForm.style.borderRadius = '15px';
                if (currentController) currentController.abort();
            }
        });

        // Focus & Click Outside
        document.addEventListener('click', (e) => {
            if (!navSearchForm.contains(e.target)) {
                navResultsBox.style.display = 'none';
                navSearchForm.classList.remove('results-open');
            }
        });
        navSearchInput.addEventListener('focus', () => {
            const query = navSearchInput.value.trim();
            if (query.length > 2) {
                navResultsBox.style.display = 'block';
                fetchNavResults(query);
            }
        });
    }

    // --- E. LIKE & SAVE INTERACTIONS ---
    const likeBtn = document.getElementById('likeBtn');
    const saveBtn = document.getElementById('saveBtn');
    const dot = document.querySelector('.dot');

    function burstLikes() {
        let count = 0;
        const interval = setInterval(() => {
            if (count >= 30) return clearInterval(interval);
            const like = document.createElement('div');
            like.classList.add('like');
            like.textContent = '‚ù§Ô∏è';
            const size = Math.random() * 16 + 16;
            like.style.cssText = `font-size: ${size}px; left: ${Math.random() * window.innerWidth}px; animation-duration: ${Math.random() * 2 + 2}s;`;
            document.body.appendChild(like);
            setTimeout(() => like.remove(), 4000);
            count++;
        }, 20);
    }

    function handleInteraction(btn, actionType, dotElement = null) {
        const url = btn.dataset.url;
        const activeClass = actionType === 'like' ? 'like-active' : 'save-active';
        const wasActive = btn.classList.contains(activeClass);
        
        // Optimistic UI
        btn.classList.toggle(activeClass);
        window.playUiSound();

        if (actionType === 'like') {
             if(!wasActive) { showToast('Liked!'); burstLikes(); }
             else { showToast('Unliked'); }
        }
        if (actionType === 'save') {
             if(!wasActive) { showToast('Added to Read Later'); if(dotElement) dotElement.style.display = "block"; }
             else { showToast('Removed from Read Later'); if(dotElement) dotElement.style.display = "none"; }
        }

        // Server Request
        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) showToast(data.message); 
            // Consistency Check
            if (actionType === 'save' && data.status !== 'saved' && data.status !== 'removed') {
                 // Revert if error
                 btn.classList.toggle(activeClass);
                 if (dotElement) dotElement.style.display = wasActive ? "block" : "none";
            }
            if (actionType === 'like' && data.status !== 'liked' && data.status !== 'unliked') {
                 btn.classList.toggle(activeClass);
            }
        })
        .catch(err => {
            console.error(err);
            showToast('Connection error');
            // Revert UI
            btn.classList.toggle(activeClass);
            if (actionType === 'save' && dotElement) dotElement.style.display = wasActive ? "block" : "none";
        });
    }

    if (likeBtn) likeBtn.addEventListener('click', () => handleInteraction(likeBtn, 'like'));
    if (saveBtn) saveBtn.addEventListener('click', () => handleInteraction(saveBtn, 'save', dot));

    // --- F. LOGIN MODAL & DROPDOWNS ---
    const startlogin = document.getElementById('startlogin');
    const loginSection = document.getElementById('loginSection');
    const closelogin = document.getElementById('closelogin');

    if (startlogin && loginSection) {
        startlogin.addEventListener('click', () => { window.playUiSound(); loginSection.classList.add('active'); });
        if(closelogin) closelogin.addEventListener('click', () => { window.playUiSound(); loginSection.classList.remove('active'); });
        loginSection.addEventListener('click', (e) => { if (e.target === loginSection) loginSection.classList.remove('active'); });
    }

    const dropdownButton = document.getElementById('dropdown-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    if (dropdownButton && dropdownMenu) {
        dropdownButton.addEventListener('click', (e) => {
            e.stopPropagation();
            window.playUiSound();
            dropdownMenu.classList.toggle('hidden');
        });
        window.addEventListener('click', (e) => {
            if (!dropdownMenu.contains(e.target) && !dropdownButton.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    }

    // --- G. ZOOM ON WHEEL (For Book Container) ---
    const container = document.getElementById('container');
    if (container) {
        let scale = 1;
        const zoomSpeed = 0.01;
        const minScale = 0.5;
        const maxScale = 2.0;

        container.addEventListener('wheel', (e) => {
            if (e.ctrlKey) return; // Let browser handle ctrl+scroll? 
            e.preventDefault();

            if (e.deltaY < 0) scale += zoomSpeed;
            else scale -= zoomSpeed;

            scale = Math.min(Math.max(minScale, scale), maxScale);
            container.style.transform = `scale(${scale})`;
        }, { passive: false });
    }

    // --- H. ERROR ALERTS FADE OUT ---
    const errorDiv = document.querySelector('.error');
    if (errorDiv) {
        const timer = setTimeout(() => {
            errorDiv.classList.add('fade-out');
            errorDiv.addEventListener('animationend', () => errorDiv.remove());
        }, 3000);
        const closeErr = errorDiv.querySelector('.error__close');
        if(closeErr) closeErr.addEventListener('click', () => {
            clearTimeout(timer);
            errorDiv.remove();
        });
    }

    // --- I. LAZY LOAD IMAGES ---
    document.querySelectorAll(".pagestyle img").forEach(img => {
        img.loading = "lazy";
        img.decoding = "async";
    });

    // --- J. INIT ICONS (Last Step) ---
    if (typeof lucide !== 'undefined') lucide.createIcons();

  }); 
</script>
  </body>
</html>