{% extends 'base.html' %}
{% load static %}

{% block title %}
  {{ title }}- Discover & Read Your Favorite Books
{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/library.css' %}" />
{% endblock %}

{% block body %}
  <!-- loginpage -->
  {% include 'login.html' %}
  
  {% if not request.path == '/book/my-books/' %}
  {% if categories %}

  <div class="filter-section-wrapper">
    <button class="scroll-btn left-scroll-btn" onclick="scrollFilters('left')"><i data-lucide="chevron-left"></i></button>

    <div class="filter-section" id="filter-scroll-container">
      <a href="{% url 'library' %}" class="filter-item {% if not category %}active{% endif %}">All</a>

      {% for cat in categories %}
        <a href="{% url 'category' cat.slug %}" class="filter-item {% if category.slug == cat.slug %}active{% endif %}">{{ cat.name }}</a>
      {% endfor %}
    </div>

    <button class="scroll-btn right-scroll-btn" onclick="scrollFilters('right')"><i data-lucide="chevron-right"></i></button>
  </div>
  {% endif %}
  {% endif %}
    

  {% if user.is_authenticated %}
    {% if request.path == '/book/library/' %}
      <section class="recent-books-section">
        <div class="container">
          <h2 class="section-title">Recently Read Books</h2>
          {% if recently_read_books %}
            <div class="book-list">
              {% for read_item in recently_read_books %}
                {% with book=read_item.book %}
                  <a href="{% url 'book' book.slug %}" class="book-card">
                    {% if book.cover_front %}
                      <div class="book-wrapper">
                        <img src="{{ book.cover_front.url }}" alt="{{ book.title }} Cover" class="book-cover" />
                        <div class="book-info-overlay">
                          <p class="book-title">{{ book.title }}</p>
                          <p class="book-author">{{ book.author }}</p>
                        </div>
                      </div>
                    {% else %}
                      <div class="book-wrapper">
                        <img src="{% static 'images/default_cover.png' %}" alt="No Cover Available" class="book-cover" />
                        <div class="book-info-overlay">
                          <p class="book-title">{{ book.title }}</p>
                          <p class="book-author">{{ book.author }}</p>
                        </div>
                      </div>
                    {% endif %}
                  </a>
                {% endwith %}
              {% endfor %}
            </div>
          {% else %}
            <p class="text-center">You haven't marked any books as read yet. Start reading and they'll appear here! ðŸ“š</p>
          {% endif %}
        </div>
      </section>
    {% endif %}
  {% endif %}
  <section class="bg-white">
    <div class="container">
      {% if search and not books %}
        <div class="fallback-modern">
          <div class="fallback-card">
            <img class="fallback-icon" src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" loading="lazy" alt="No books" />
            <h2>Oops! No books here yet...</h2>
            <p>
              Hmm... Looks like we couldnâ€™t find anything for <strong>"{{ search }}"</strong> search results:(
            </p>
            <a href="{% url 'library' %}" class="fallback-link">Explore Library</a>
          </div>
        </div>
      {% elif not books %}
        <div class="fallback-modern">
          <div class="fallback-card">
            <img class="fallback-icon" src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" loading="lazy" alt="No books" />
            <h2>Oops! No books here yet...</h2>
            <p>Looks like this category is still waiting for its first book.</p>
            <a href="{% url 'library' %}" class="fallback-link">Explore Library</a>
          </div>
        </div>
      {% else %}
        <div class="section-header">
          {% if search %}
            <h2 style="font-size: 1.8rem;">Search results for <u>{{ search }}</u></h2>
          {% else %}
            {% if title == 'Your Wishlist' %}
              <h2 style="font-size: 1.8rem;">Your Saved Books</h2>
              <p>Read anytime, anywhere.</p>
            {% else %}
              <h2 style="font-size: 1.8rem;">Explore the Collection {{ category }}</h2>
              <p>A vast range of books curated just for you.</p>
            {% endif %}
          {% endif %}
        </div>
        <div class="books-grid">
          {% for book in books %}
            {% if book.is_published %}
              <div class="book-item" style="position: relative;">
                <a href="{% url 'book' book.slug %}">
                  <img class="imgbook" src="{{ book.cover_front.url }}" alt="Book Cover 1" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x600/cccccc/ffffff?text=Image+Failed';" />
                  <img loading="lazy" style="position: absolute;left: -4px;top: -2px;box-shadow: none;width: 102%;height: 82%;" src="{% static 'images/framebook1.png' %}" alt="frame" />
                  <div style="box-shadow: 2px 2px 3px #3a3a3a38;border-radius: 0px 0px 5px 5px;">
                    <div class="readby">
                      <h3 class="truncate">{{ book.title }}</h3>
                      <div class="views" style="margin-right: 5px;">
                        <h4>{{ book.readby_count }}</h4> <i style="width: 16px;" data-lucide="eye"></i>
                      </div>
                    </div>
                    <div style="display: flex;justify-content: space-between;align-items: center;" class="truncate">
                      <p>
                        <span style="font-weight: 700;">by:</span> {{ book.author }}
                      </p>
                      <div style="font-size: 14px;align-items: center;display: flex;margin-right: 5px;">
                        <i style="height: 16px;fill: #007BFF;color: #0358ff;" data-lucide="thumbs-up"></i>{{ book.likes_count }}
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
    {% if books.paginator.num_pages > 1 %}
      <div class="pagination">
        {% if books.has_previous %}
          <a href="?page={{ books.previous_page_number }}" class="page-btn">Previous</a>
        {% else %}
          <span class="page-btn disabled">Previous</span>
        {% endif %}

        <!-- First page -->
        {% if books.number > 3 %}
          <a href="?page=1" class="page-btn">1</a>
          <span class="dots">...</span>
        {% endif %}

        <!-- Pages near current page -->
        {% for num in books.paginator.page_range %}
          {% if num >= books.number|add:'-2' and num <= books.number|add:'2' %}
            {% if books.number == num %}
              <span class="page-btn current">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Last page -->
        {% if books.number < books.paginator.num_pages|add:'-2' %}
          <span class="dots">...</span>
          <a href="?page={{ books.paginator.num_pages }}" class="page-btn">{{ books.paginator.num_pages }}</a>
        {% endif %}

        {% if books.has_next %}
          <a href="?page={{ books.next_page_number }}" class="page-btn">Next</a>
        {% else %}
          <span class="page-btn disabled">Next</span>
        {% endif %}
      </div>
    {% endif %}
  </section>
  <script>
    function scrollFilters(direction) {
      const container = document.getElementById('filter-scroll-container')
      const scrollDistance = 200
    
      if (container) {
        let scrollAmount = direction === 'left' ? -scrollDistance : scrollDistance
    
        container.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        })
      }
    }
  </script>
{% endblock %}
