<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load socialaccount %}
{% load cloudinary %}

<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Read {{ title }} by {{ book.author }} online. {{ bookcontent|truncatewords:25 }}" />
    <link rel="canonical" href="{{ request.build_absolute_uri }}" />
    <title>{{ title }} - By {{ book.author }} | LeafyReads</title>
    <meta property="og:type" content="book" />
    <meta property="og:title" content="{{ title }} - By {{ book.author }}" />
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-2QEBBBDZKY"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-2QEBBBDZKY');
      </script>
    <meta property="og:description" content="Read {{ title }} online at LeafyReads." />
    <meta property="og:image" content="{{ book.cover_front.url }}" /> <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=96 height=96 crop='scale' %}" sizes="96x96" type="image/png">
    <link rel="icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=48 height=48 crop='scale' %}" sizes="48x48" type="image/png">
    <link rel="apple-touch-icon" href="{% cloudinary_url 'tydxjsqbzu7g2vvuoonc' format='png' width=180 height=180 crop='scale' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="{% static 'css/mobilebook.css' %}" />
    <link rel="stylesheet" href="{% static 'css/login.css' %}" />
    <link rel="stylesheet" href="{% static 'css/limit_reached.css' %}">

 <style>
    body {
      min-height: 100vh;
      position: relative;
      margin: 0;
    }


    .leafy-auth-container{
        max-width: 80%;
        padding: 1rem;
    }
    .tool-active {
        background-color: #f59e0b !important; /* Orange */
        color: white !important;
        transform: scale(1.1);
    }
  </style>
  {% include 'book_detail.html' %}
</head>

<body>
  {% if limit_reached %}
{% include 'limit_reached.html' %}
{% else %}
  {% if messages %}
  <div
    class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start"
    role="alert">
    <div class="error__icon mr-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
        <path fill-rule="evenodd"
          d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z"
          clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="error__title grow">
      <ul style="padding:0px 14px;" class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
    <div class="error__close ml-4 cursor-pointer">
      <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
        class="text-gray-700 hover:text-gray-900 transition-colors">
        <path
          d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z">
        </path>
      </svg>
    </div>
  </div>
  {% endif %}
  <div class="notification-box glass-panel" id="notificationBox">
    <div class="notif-header">
      <h3>Notifications</h3>
      <button class="mark-read-text">Mark all read</button>
    </div>

    <div class="notif-list">
      {% if notifications %}
      {% for notif in notifications %}

      {% if notif.notification_type == 'post_delete' %}
      <div class="notif-item" style="cursor: default;">
        <div class="notif-icon-box bg-teal">
          üóëÔ∏è
        </div>
        <div class="notif-content">
          <p>{{ notif.message|safe }}</p>
          <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
        </div>
      </div>
      {% elif notif.notification_type == 'promotion' %}
      <a href="{% url 'promo_link' notif.id %}" style="text-decoration: none; color: inherit;">
        <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
          <div class="notif-icon-box bg-purple">üî•</div>
          <div class="notif-content">
            <p>{{ notif.message|safe }}</p>
            <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
          </div>
        </div>
      </a>
      {% elif notif.notification_type == 'draft_saved' %}
      <a href="{% url 'updateUserBook'  notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
        <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
          <div class="notif-icon-box bg-purple">üìñ</div>
          <div class="notif-content">
            <p>{{ notif.message|safe }}</p>
            <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
          </div>
        </div>
      </a>
      {% elif notif.notification_type == 'book_review' %}
      <a href="{% url 'updateUserBook'  notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
        <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
          <div class="notif-icon-box bg-purple">üì§</div>
          <div class="notif-content">
            <p>{{ notif.message|safe }}</p>
            <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
          </div>
        </div>
      </a>
      {% elif notif.notification_type == 'book_published' %}
      <a href="{% url 'book'  notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
        <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
          <div class="notif-icon-box bg-purple">üéâ</div>
          <div class="notif-content">
            <p>{{ notif.message|safe }}</p>
            <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
          </div>
        </div>
      </a>
      {% else %}
      <a href="{% url 'post_view' notif.content_object.slug %}" style="text-decoration: none; color: inherit;">
        <div class="notif-item {% if not notif.is_read %}unread{% endif %} hover:bg-gray-50 transition">
          <div class="notif-icon-box bg-teal">
            {% if notif.notification_type == 'like' %}‚ù§Ô∏è
            {% elif notif.notification_type == 'comment' %}üí¨
            {% elif notif.notification_type == 'book_mention' %}üìö
            {% else %}üîî{% endif %}
          </div>
          <div class="notif-content">
            <p>{{ notif.message|safe }}</p>
            <span class="notif-time">{{ notif.created_at|timesince }} ago</span>
          </div>
        </div>
      </a>
      {% endif %}

      {% endfor %}
      {% else %}
      <div style="padding: 1.5rem; text-align: center; color: #94a3b8; font-size: 0.85rem;">
        <p>No new updates</p>
      </div>
      {% endif %}

      <div class="notif-item">
        <div class="notif-icon-box bg-teal">
          <i data-lucide="sparkles"></i>
        </div>
        <div class="notif-content">
          <p><strong>Welcome to LeafyReads!</strong> üåø Discover new books...</p>
          <span class="notif-time">{{ user.date_joined|timesince }} ago</span>
        </div>
      </div>
    </div>
    <div class="notif-footer">
      <a href="#">View All History</a>
    </div>
  </div>
  <section class="loginpagesection" id="loginSection">
    <div class="leafy-auth-container" style="width: 380px;" id="loginContainer">
      <button class="close-btn" id="closelogin">&times;</button>
      <div class="login-logo" style="display: flex; align-items: center; justify-content: center;">
        {% cloudinary "qqeschqzlywacz6rqsbl" style="width: 60px; border-radius: 15px;" loading="lazy" alt="logo"  %}
        {% cloudinary "tdehybbsyciqodgxs2rq" class="login-leafy-light" style="width: 140px; border-radius: 15px;" loading="lazy" alt="LeafyReads"  %}
        {% cloudinary "kp6b6xlwuu8d52cfhfba" class="login-leafy-dark" style="width: 140px; border-radius: 15px;" loading="lazy" alt="LeafyReads"  %}
      </div>
      <h3 style="margin: 0;">Create Your Account</h3>
      <div class="leafy-sub-text">
        Already have an account? <a href="/" style="color:#4e8ef7;">Sign in</a>
      </div>
      {% cloudinary "ht4lblz4fxlllxlbw5sa" style="width: 100%; height:25vh;" loading="lazy" alt="Funny loading GIF"  %}

      <a style="width: 94%;" href="{% provider_login_url 'google' %}?next={{ request.path }}"
        class="leafy-auth-button google">
        <img src="https://cdn-icons-png.flaticon.com/512/281/281764.png" loading="lazy" alt="Google icon" />
        Continue with Google
      </a>

      <a href="{% provider_login_url 'facebook' method='oauth2' %}" style="background: #08446f;color: white;width: 94%;" class="leafy-auth-button facebook">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" loading="lazy" alt="Facebook icon" />
        Sign in with Facebook
      </a>

      <div class="support-section">
        <h4>Support LeafyReads</h4>
        <p style="font-size: 13px;">Your contributions help us keep the library free and support rising authors.</p>
        
        <button class="leafy-auth-button donate">
          <img src="https://cdn-icons-png.flaticon.com/512/2589/2589175.png" loading="lazy" alt="Heart icon" />
          Support our Mission
        </button>
      </div>

      <div class="leafy-terms">
        By clicking "signup" you agree to our <a href="{% url 'terms-of-service' %}">Terms of Service</a> & <a href="{% url 'privacy-policy' %}">Privacy Policy</a>.
      </div>
    </div>
  </section>

  <div id="loader-overlay" style="display:flex;flex-direction: column;">
    <img src="{% static 'images/Book.gif' %}" style="width: 100px;" alt="Loading..." />
    <h4>Unfolding stories, please wait...</h4>
  </div>

  <header class="co-header">
    <div class="co-container">
      <div class="co-header-content">
        <a href="/" class="logo">
          {% cloudinary "qqeschqzlywacz6rqsbl" class="logo-icon" style="width: 48px; border-radius: 15px;" alt="logo"  %}
          {% cloudinary "tdehybbsyciqodgxs2rq" class="logo-light" style="width: 105px; border-radius: 15px;" alt="LeafyReads"  %}
          {% cloudinary "kp6b6xlwuu8d52cfhfba" class="logo-dark" style="width: 105px; border-radius: 15px;" alt="LeafyReads"  %}
        </a>
        <div class="co-header-actions">
          {% if user.is_authenticated %}
          <div class="dropdown">
            <button id="dropdown-button" class="btn">Welcome {{ user.first_name }} <i
                data-lucide="arrow-big-down-dash"></i></button>

            <ul id="dropdown-menu" class="dropdown-menu hidden">
              {% if user.is_staff %}
              <a href="/admin-dashboard/">
                <li class="dropdown-item">
                  <i data-lucide="shield-check"></i>
                  <span>Admin Pannel</span>
                </li>
              </a>
              {% else %}
              <a href="{% url 'profilepage' %}">
                <li class="dropdown-item">
                  <i data-lucide="user-pen"></i>
                  <span>My Dashboard</span>
                </li>
              </a>
              <li onclick="toggleNotifications()" class="dropdown-item" style="position: relative;">
                <i data-lucide="bell"></i>
                <p class="notify-dot" style="left: 25px;"></p>
                <span>Notification</span>
              </li>
              <li class="dropdown-item">
                <i data-lucide="gem"></i>
                <span>Go Pro</span>
              </li>
              <a href="{% url 'aboutUs' %}">
                <li class="dropdown-item">
                  <i data-lucide="info"></i>
                  <span>About Us</span>
                </li>
              </a>
              {% endif %}
              <li class="separator"></li>
              <a href="{% url 'logout' %}">
                <li class="dropdown-item">
                  <i data-lucide="log-out"></i>
                  <span>Logout</span>
                </li>
              </a>
            </ul>
          </div>
          {% else %}
          <div style="display: flex;align-items: center;justify-content: center;gap: 4px;" id="startlogin"
            class="btn primary-btn"><span>Start Reading Now </span><i style="width: 20px;" data-lucide="sparkles"></i>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </header>
  <div id="overlaysearch"></div>
  <div class="goto-page-box" id="gotobox">
      <input type="number" id="pageInput" placeholder="Go to page 1 to {{ page_obj.paginator.num_pages }}....." min="1" max="{{ page_obj.paginator.num_pages }}" data-total="{{ page_obj.paginator.num_pages }}" />
      <button id="goBtn">Go <i style="width: 20px;" data-lucide="scan-search"></i> </button> 
  </div>

  {% if request.user_agent.is_mobile %}
    <div class="fab-container" id="fabContainer">
      <button id="fabTrigger" class="fab-btn main-btn">
        <i data-lucide="plus"></i>
      </button>

      <div class="fab-options">
        {% if user.is_authenticated %}
        <a href="{% url 'community' %}" id="comment" class="fab-btn mini-btn" title="Community">
          <i data-lucide="messages-square"></i>
        </a>

        <button id="saveBtn" style="border:3px solid #ff9209;" class="fab-btn mini-btn {% if saved %}save-active{% endif %}" title="Save"
          data-url="{% url 'toggle_read_later' book.slug %}">
          <i data-lucide="bookmark"></i>
        </button>

        <button id="likeBtn" style="border: 3px solid #09a2ff;" class="fab-btn mini-btn {% if liked %}like-active{% endif %}" title="Like"
          data-url="{% url 'toggle_like' book.slug %}">
          <i data-lucide="thumbs-up"></i>
        </button>
        {% endif %} 
        
        <button id="zoom-out" class="fab-btn mini-btn" title="zoom-out">
          <i data-lucide="zoom-out"></i> 
        </button>
        <button id="zoom-in" class="fab-btn mini-btn" title="zoom-in">
          <i data-lucide="zoom-in"></i> 
        </button>
        <a href="{% url 'library' %}" disabled id="play" class="fab-btn mini-btn" title="library">
          <i data-lucide="house"></i>
        </a>
        <button id="searchpage" class="fab-btn mini-btn" title="search page">
          <i data-lucide="text-select"></i> 
        </button>

        <button disabled id="play" class="fab-btn mini-btn" title="Listen">
          <i data-lucide="play"></i>
        </button>

        <button id="darkModeBtn" class="fab-btn mini-btn" title="Dark Mode">
          <i data-lucide="moon"></i>
        </button>
      </div>
  {% else %}
      <div class="fab-options" style="position:fixed;bottom: 25px; right: 1%; z-index: 1;">
        {% if user.is_authenticated %}
        <a href="{% url 'community' %}" id="comment" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="Community">
          <i data-lucide="messages-square"></i>
        </a>

        <button id="saveBtn" style="opacity:1;transform:none;border: 4px solid #ff9209;" class="fab-btn mini-btn {% if saved %}save-active{% endif %}" title="Save"
          data-url="{% url 'toggle_read_later' book.slug %}">
          <i data-lucide="bookmark"></i>
        </button>

        <button id="likeBtn" style="opacity:1;transform:none;border: 4px solid #09a2ff;" class="fab-btn mini-btn {% if liked %}like-active{% endif %}" title="Like"
          data-url="{% url 'toggle_like' book.slug %}">
          <i data-lucide="thumbs-up"></i>
        </button>
        {% endif %} 
        
        <button id="zoom-out" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="zoom-out">
          <i data-lucide="zoom-out"></i> 
        </button>
        <button id="zoom-in" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="zoom-in">
          <i data-lucide="zoom-in"></i> 
        </button>
        <a href="{% url 'library' %}" disabled id="play" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="library">
          <i data-lucide="house"></i>
        </a>
        <button id="searchpage" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="search page">
          <i data-lucide="text-select"></i> 
        </button>

        <a href="{% url 'read-book' book.slug %}" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="Switch to Book view">
          <i data-lucide="book-open"></i>  
        </a>

        <button disabled id="play" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="Listen">
          <i data-lucide="play"></i>
        </button>

        <button id="darkModeBtn" style="opacity:1;transform:none;" class="fab-btn mini-btn" title="Dark Mode">
          <i data-lucide="moon"></i>
        </button>
      </div>
  {% endif %}
    <div id="toast-notification" class="toast">
      <span id="toast-message"></span>
    </div>
  </div>


  <main id="container-wrapper">
    {% if request.user_agent.is_mobile %}
    <section id="container">
        {{ bookcontent|safe }}
    </section>
    {% else %}
    <div id="resize-shell">
      <section id="container">
          {{ bookcontent|safe }}
      </section>
      <div class="resizer resizer-l"></div>
      <div class="resizer resizer-r"></div>
      <div class="resizer resizer-b"></div>
    </div>
    {% endif %}
  </main>
  <div class="pagination-container">

      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="nav-btn">
        <i data-lucide="chevron-left"></i>
      </a>
      {% else %}
      <button class="nav-btn disabled">
        <i data-lucide="chevron-left"></i>
      </button>
      {% endif %}

      <div class="page-info">
        <span class="current-page">Page {{ page_obj.number }}</span>
        <span class="total-pages">of {{ page_obj.paginator.num_pages }}</span>
      </div>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="nav-btn">
        <i data-lucide="chevron-right"></i>
      </a>
      {% else %}
      <button class="nav-btn disabled">
        <i data-lucide="chevron-right"></i>
      </button>
      {% endif %}

    </div>
  <script src="{% static 'js/loading.js' %}"></script>
<script>
  // --- 1. GLOBAL HELPER: UI SOUND ---
  const uiClickSound = new Audio('/static/sounds/click.mp3');
  window.playUiSound = function() {
    uiClickSound.currentTime = 0;
    uiClickSound.play().catch(e => { /* Ignore auto-play errors */ });
  };
  window.toggleNotifications = function() {
    // 1. Force Close the Dropdown Menu if it's open
    const dropdown = document.getElementById('dropdown-menu');
    if (dropdown) {
      dropdown.classList.add('hidden'); 
    }

    // 2. Toggle the Notification Box
    const box = document.getElementById('notificationBox');
    if (box) box.classList.toggle('active');
  };

  document.addEventListener('DOMContentLoaded', () => {

    // --- 2. GLOBAL UI CONSTANTS ---
    const toast = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');
    const csrfToken = '{{ csrf_token }}'; // Django Token

    function showToast(message) {
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      } else {
        alert(message);
      }
    }
    document.addEventListener('click', (event) => {
    const target = event.target;

    // 1. Close Notifications
    const notifBox = document.getElementById('notificationBox');

    const isTrigger = target.closest('[onclick="toggleNotifications()"]') || target.closest('.notif-btn');

    if (notifBox && notifBox.classList.contains('active')) {
      // If click is NOT inside the box AND NOT on a trigger button, close it
      if (!notifBox.contains(target) && !isTrigger) {
        notifBox.classList.remove('active');
      }
    }
  });

    // --- 3. RESIZE LOGIC (With SessionStorage) ---
    const shell = document.getElementById('resize-shell');
    if (shell) {
      // Restore Saved Size
      const savedWidth = sessionStorage.getItem('bookContainerWidth');
      const savedHeight = sessionStorage.getItem('bookContainerHeight');
      if (savedWidth) shell.style.width = savedWidth;
      if (savedHeight) shell.style.height = savedHeight;

      // Resizing Handlers
      const resizers = shell.querySelectorAll('.resizer');
      let isResizing = false;
      let currentResizer;

      resizers.forEach(resizer => {
        resizer.addEventListener('mousedown', function (e) {
          e.preventDefault();
          isResizing = true;
          currentResizer = resizer;
          resizer.classList.add('resizing');

          const rect = shell.getBoundingClientRect();
          const startX = e.clientX;
          const startY = e.clientY;
          const startWidth = rect.width;
          const startHeight = rect.height;
          const maxAllowedHeight = window.innerHeight * 0.9;

          function onMouseMove(e) {
            if (!isResizing) return;

            // RESIZE RIGHT
            if (currentResizer.classList.contains('resizer-r')) {
              const newWidth = startWidth + (e.clientX - startX);
              if (newWidth > 500) shell.style.width = newWidth + 'px';
            }
            // RESIZE BOTTOM
            else if (currentResizer.classList.contains('resizer-b')) {
              let newHeight = startHeight + (e.clientY - startY);
              if (newHeight > 400 && newHeight <= maxAllowedHeight) {
                shell.style.height = newHeight + 'px';
              }
            }
            // RESIZE LEFT
            else if (currentResizer.classList.contains('resizer-l')) {
              const newWidth = startWidth - (e.clientX - startX);
              if (newWidth > 300) shell.style.width = newWidth + 'px';
            }
          }

          function onMouseUp() {
            isResizing = false;
            if (currentResizer) currentResizer.classList.remove('resizing');
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);

            // Save preference
            sessionStorage.setItem('bookContainerWidth', shell.style.width);
            sessionStorage.setItem('bookContainerHeight', shell.style.height);
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    // --- 4. AUDIO PLAYER MODULE ---
    const audioUrl = "{% if book.audio_file %}{{ book.audio_file.url }}{% endif %}";
    const playBtn = document.querySelector('#play:not([href])'); 

    if (audioUrl && playBtn) {
      const audioFile = new Audio(audioUrl);
      
      playBtn.removeAttribute('disabled');
      playBtn.style.cursor = 'pointer';

      playBtn.addEventListener('click', () => {
        window.playUiSound();
        if (audioFile.paused) {
          const playPromise = audioFile.play();
          if (playPromise !== undefined) {
            playPromise.then(() => {
              playBtn.innerHTML = '<i data-lucide="pause"></i>';
              if (window.lucide) lucide.createIcons();
            }).catch(error => {
              console.error("Playback error:", error);
              if (error.name === "NotSupportedError") showToast("Audio format not supported.");
            });
          }
        } else {
          audioFile.pause();
          playBtn.innerHTML = '<i data-lucide="play"></i>';
          if (window.lucide) lucide.createIcons();
        }
      });

      audioFile.addEventListener('ended', () => {
        playBtn.innerHTML = '<i data-lucide="play"></i>';
        if (window.lucide) lucide.createIcons();
      });
      audioFile.addEventListener('error', (e) => console.error("Audio Load Error:", audioFile.error));
    }

    // --- 5. NAVIGATION & SEARCH MODULE ---
    const searchbtn = document.getElementById('searchpage');
    const gotobox = document.getElementById('gotobox');
    const goBtn = document.getElementById('goBtn');
    const pageInput = document.getElementById('pageInput');
    const overlaysearch = document.getElementById('overlaysearch');

    function navigateToPage() {
      if (!pageInput) return;
      const pageNum = parseInt(pageInput.value);
      const maxPages = pageInput.dataset.total ? parseInt(pageInput.dataset.total) : 1000;

      if (pageNum >= 1 && pageNum <= maxPages) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', pageNum);
        if (gotobox) gotobox.style.visibility = "hidden";
        if (searchbtn) searchbtn.classList.remove('tool-active');
        window.location.href = url.toString();
      } else {
        showToast(`Enter a page between 1 and ${maxPages}.`);
        pageInput.value = "";
        pageInput.focus();
      }
    }

    if (goBtn) goBtn.addEventListener('click', () => { window.playUiSound(); navigateToPage(); });
    if (pageInput) pageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') navigateToPage(); });

    if (searchbtn && gotobox) {
      searchbtn.addEventListener('click', (e) => {
        e.stopPropagation();
        window.playUiSound();
        const isVisible = gotobox.style.visibility === "visible";
        gotobox.style.visibility = isVisible ? "hidden" : "visible";
        overlaysearch.style.visibility = isVisible ? "hidden" : "visible";
        overlaysearch.style.opacity = isVisible ? "0" : "1";
        
        if (!isVisible) {
            searchbtn.classList.add('tool-active');
            const input = gotobox.querySelector('input');
            if (input) input.focus();
        } else {
            searchbtn.classList.remove('tool-active');
        }
      });
    }

    // --- 6. ZOOM MODULE ---
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const containerParagraphs = document.querySelectorAll('#container p');
    let currentFontSize = 16;

    if (zoomInBtn && zoomOutBtn && containerParagraphs.length > 0) {
      const updateZoom = (change) => {
        window.playUiSound();
        const newSize = currentFontSize + change;
        if (newSize >= 10 && newSize <= 30) {
          currentFontSize = newSize;
          containerParagraphs.forEach(p => p.style.fontSize = `${currentFontSize}px`);
          showToast(`Zoom: ${currentFontSize}px`);
        } else {
          showToast(change > 0 ? "Max Zoom Reached" : "Min Zoom Reached");
        }
      };
      zoomInBtn.addEventListener('click', (e) => { e.stopPropagation(); updateZoom(2); });
      zoomOutBtn.addEventListener('click', (e) => { e.stopPropagation(); updateZoom(-1); });
    }

    // --- 7. FAB MENU ---
    const fabContainer = document.getElementById('fabContainer');
    const fabTrigger = document.getElementById('fabTrigger');

    if (fabTrigger && fabContainer) {
      fabTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        window.playUiSound();
        fabContainer.classList.toggle('active');

        const closeMenu = (evt) => {
          if (!fabContainer.contains(evt.target) && (!gotobox || !gotobox.contains(evt.target))) {
            fabContainer.classList.remove('active');
            if(gotobox) gotobox.style.visibility = "hidden";
            if(overlaysearch) { overlaysearch.style.visibility = "hidden"; overlaysearch.style.opacity = "0"; }
            if(searchbtn) searchbtn.classList.remove('tool-active');
            document.removeEventListener('click', closeMenu);
          }
        };

        if (fabContainer.classList.contains('active')) {
          document.addEventListener('click', closeMenu);
        }
      });
    }
    
    document.querySelectorAll('.fab-options a.fab-btn').forEach(link => {
        link.addEventListener('click', window.playUiSound);
    });

    // --- 8. DARK MODE ---
    const darkModeBtn = document.getElementById('darkModeBtn');
    const body = document.body;
    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark-mode');
      if (darkModeBtn) darkModeBtn.innerHTML = '<i data-lucide="sun"></i>';
    }
    if (darkModeBtn) {
      darkModeBtn.addEventListener('click', () => {
        window.playUiSound();
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        darkModeBtn.innerHTML = isDark ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>';
        if (window.lucide) lucide.createIcons();
      });
    }

    // --- 9. LIKE & SAVE ---
    const likeBtn = document.getElementById('likeBtn');
    const saveBtn = document.getElementById('saveBtn');
    const dot = document.querySelector('.dot');

    function burstLikes() {
      let count = 0;
      const interval = setInterval(() => {
        if (count >= 30) return clearInterval(interval);
        const like = document.createElement('div');
        like.classList.add('like');
        like.textContent = '‚ù§Ô∏è';
        const size = Math.random() * 16 + 16;
        like.style.cssText = `font-size: ${size}px; left: ${Math.random() * window.innerWidth}px; animation-duration: ${Math.random() * 2 + 2}s;`;
        document.body.appendChild(like);
        setTimeout(() => like.remove(), 4000);
        count++;
      }, 20);
    }

    function handleInteraction(btn, actionType, dotElement = null) {
      const url = btn.dataset.url;
      const activeClass = actionType === 'like' ? 'like-active' : 'save-active';
      const wasActive = btn.classList.contains(activeClass);
      btn.classList.toggle(activeClass);
      window.playUiSound();

      if (actionType === 'like' && !wasActive) burstLikes();
      if (actionType === 'save' && dotElement) dotElement.style.display = !wasActive ? "block" : "none";

      fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
      })
      .then(response => response.json())
      .then(data => {
          showToast(data.message);
          if (actionType === 'save' && data.status !== 'saved' && data.status !== 'removed') {
               btn.classList.toggle(activeClass);
               if (dotElement) dotElement.style.display = wasActive ? "block" : "none";
          }
          if (actionType === 'like' && data.status !== 'liked' && data.status !== 'unliked') {
              btn.classList.toggle(activeClass);
          }
      })
      .catch(err => {
          console.error(err);
          showToast('Action failed. Try again.');
          btn.classList.toggle(activeClass);
          if (actionType === 'save' && dotElement) dotElement.style.display = wasActive ? "block" : "none";
      });
    }

    if (likeBtn) likeBtn.addEventListener('click', () => handleInteraction(likeBtn, 'like'));
    if (saveBtn) saveBtn.addEventListener('click', () => handleInteraction(saveBtn, 'save', dot));

    // --- 10. LOGIN & DROPDOWNS ---
    const startlogin = document.getElementById('startlogin');
    const loginSection = document.getElementById('loginSection');
    const closelogin = document.getElementById('closelogin');
    
    if (startlogin && loginSection) {
        startlogin.addEventListener('click', () => { window.playUiSound(); loginSection.classList.add('active'); });
        if(closelogin) closelogin.addEventListener('click', () => { window.playUiSound(); loginSection.classList.remove('active'); });
        loginSection.addEventListener('click', (e) => { if (e.target === loginSection) loginSection.classList.remove('active'); });
    }

    const dropdownButton = document.getElementById('dropdown-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    if (dropdownButton && dropdownMenu) {
        dropdownButton.addEventListener('click', (e) => {
            e.stopPropagation();
            window.playUiSound();
            dropdownMenu.classList.toggle('hidden');
        });
        window.addEventListener('click', (e) => {
            if (!dropdownMenu.contains(e.target) && !dropdownButton.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    }

    // --- 11. ERROR MESSAGES FADE OUT ---
    const errorDiv = document.querySelector('.error');
    if (errorDiv) {
        const timer = setTimeout(() => {
            errorDiv.classList.add('fade-out');
            errorDiv.addEventListener('animationend', () => errorDiv.remove());
        }, 3000);
        const closeErr = errorDiv.querySelector('.error__close');
        if(closeErr) closeErr.addEventListener('click', () => {
            clearTimeout(timer);
            errorDiv.remove();
        });
    }

    // --- 12. IMAGE OPTIMIZATION ---
    const images = document.querySelectorAll("#container img");
    if(images.length > 0) {
        images.forEach(img => {
            if (img.src.includes("res.cloudinary.com") && !img.src.includes("/w_800")) {
                img.src = img.src.replace("/upload/", "/upload/w_800,q_auto,f_auto,fl_progressive/");
            }
            img.loading = "lazy";
            img.decoding = "async";
        });
        
    }
    

    // --- 13. INITIALIZE ICONS---
    if (typeof lucide !== 'undefined') lucide.createIcons();

  });
</script>
{% endif %}
</body>

</html>