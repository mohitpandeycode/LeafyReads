<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load socialaccount %}

<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Read {{ title }} by {{ book.author }} online. {{ bookcontent|truncatewords:25 }}" />
    <link rel="canonical" href="{{ request.build_absolute_uri }}" />
    <title>{{ title }} - By {{ book.author }} | LeafyReads</title>
    <meta property="og:type" content="book" />
    <meta property="og:title" content="{{ title }} - By {{ book.author }}" />
    <meta property="og:description" content="Read {{ title }} online at LeafyReads." />
    <meta property="og:image" content="{{ book.cover_front.url }}" /> <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.png' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'css/mobilebook.css' %}" />
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />

 <style>
    body {
      min-height: 100vh;
      position: relative;
      margin: 0;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-image: url('{% static "images/lightback.webp" %}');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      will-change: transform; 
    }

    /* 3. Dark Mode now updates the pseudo-element */
    body.dark-mode::before {
      background-image: url('{% static "images/backdark.webp" %}');
    }

    .leafy-auth-container{
        max-width: 80%;
        padding: 1rem;
    }
    .tool-active {
        background-color: #f59e0b !important; /* Orange */
        color: white !important;
        transform: scale(1.1);
    }
  </style>
  {% include 'book_detail.html' %}
</head>

<body>
  {% if messages %}
  <div
    class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start"
    role="alert">
    <div class="error__icon mr-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
        <path fill-rule="evenodd"
          d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z"
          clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="error__title grow">
      <ul style="padding:0px 14px;" class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
    <div class="error__close ml-4 cursor-pointer">
      <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
        class="text-gray-700 hover:text-gray-900 transition-colors">
        <path
          d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z">
        </path>
      </svg>
    </div>
  </div>
  {% endif %}
  <section class="loginpagesection" id="loginSection">
    <div class="leafy-auth-container" style="width: 380px;" id="loginContainer">
      <button class="close-btn" id="closelogin">&times;</button>
      <div class="login-logo" style="display: flex; align-items: center; justify-content: center;">
        <img style="width: 60px; border-radius: 15px;" src="{% static 'images/logo1.png' %}" loading="lazy" alt="logo">
        <img class="login-leafy-light" style="width: 140px; border-radius: 15px;"
          src="{% static 'images/leafylight.webp' %}" loading="lazy" alt="LeafyReads">
        <img class="login-leafy-dark" style="width: 140px; border-radius: 15px;"
          src="{% static 'images/leafyDark.webp' %}" loading="lazy" alt="LeafyReads">
      </div>
      <h3 style="margin: 0;">Create Your Account</h3>
      <div class="leafy-sub-text">
        Already have an account? <a href="/" style="color:#4e8ef7;">Sign in</a>
      </div>
      <img style="width: 100%; height:25vh;" src="{% static 'images/login.gif' %}" loading="lazy"
        alt="Funny loading GIF" />

      <a style="width: 94%;" href="{% provider_login_url 'google' %}?next={{ request.path }}"
        class="leafy-auth-button google">
        <img src="https://cdn-icons-png.flaticon.com/512/281/281764.png" loading="lazy" alt="Google icon" />
        Continue with Google
      </a>

      <button class="leafy-auth-button github">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" loading="lazy" alt="Facebook icon" />
        Sign in with Facebook
      </button>

      <button class="leafy-auth-button apple">
        <img src="https://cdn-icons-png.flaticon.com/512/0/747.png" loading="lazy" alt="Apple icon" />
        Sign in with Apple
      </button>

      <div class="leafy-terms">
        By clicking "signup" you agree to our <a href="{% url 'terms-of-service' %}">Terms of Service</a> & <a href="{% url 'privacy-policy' %}">Privacy Policy</a>.
      </div>

      <div class="leafy-explore">
        Continue without signup? <a href="/">explore</a>
      </div>
    </div>
  </section>

  <div id="loader-overlay" style="display:flex;flex-direction: column;">
    <img src="{% static 'images/Book.gif' %}" style="width: 100px;" alt="Loading..." />
    <h4>Unfolding stories, please wait...</h4>
  </div>

  <header class="co-header">
    <div class="co-container">
      <div class="co-header-content">
        <a href="/" class="logo">
          <img class="logo-icon" style="width: 48px; border-radius: 15px;" src="{% static 'images/logo1.png' %}" alt="logo">
          <img class="logo-light" style="width: 105px; border-radius: 15px;" src="{% static 'images/leafylight.webp' %}"
            alt="LeafyReads">
          <img class="logo-dark" style="width: 105px; border-radius: 15px;" src="{% static 'images/leafyDark.webp' %}"
            alt="LeafyReads">
        </a>
        <div class="co-header-actions">
          {% if user.is_authenticated %}
          <div class="dropdown">
            <button id="dropdown-button" class="btn">Welcome {{ user.first_name }} <i
                data-lucide="arrow-big-down-dash"></i></button>

            <ul id="dropdown-menu" class="dropdown-menu hidden">
              {% if user.is_staff %}
              <a href="/admin-dashboard/">
                <li class="dropdown-item">
                  <i data-lucide="shield-check"></i>
                  <span>Admin Pannel</span>
                </li>
              </a>
              {% else %}
              <a href="{% url 'profilepage' %}">
                <li class="dropdown-item">
                  <i data-lucide="user-pen"></i>
                  <span>Profile</span>
                </li>
              </a>
              <li class="dropdown-item">
                <i data-lucide="gem"></i>
                <span>Go Pro</span>
              </li>
              <li class="dropdown-item">
                <i data-lucide="credit-card"></i>
                <span>Billing & Plans</span>
              </li>
              <li class="dropdown-item">
                <i data-lucide="circle-question-mark"></i>
                <span>Get Help</span>
              </li>
              {% endif %}
              <li class="separator"></li>
              <a href="{% url 'logout' %}">
                <li class="dropdown-item">
                  <i data-lucide="log-out"></i>
                  <span>Logout</span>
                </li>
              </a>
            </ul>
          </div>
          {% else %}
          <div style="display: flex;align-items: center;justify-content: center;gap: 4px;" id="startlogin"
            class="btn primary-btn"><span>Start Reading Now </span><i style="width: 20px;" data-lucide="sparkles"></i>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </header>
  <div id="overlaysearch"></div>
  <div class="goto-page-box" id="gotobox">
      <input type="number" id="pageInput" placeholder="Page No..." min="1" max="{{ page_obj.paginator.num_pages }}" data-total="{{ page_obj.paginator.num_pages }}" />
      <button id="goBtn">Go <i style="width: 20px;" data-lucide="scan-search"></i> </button> 
  </div>
  <div class="fab-container" id="fabContainer">
    <button id="fabTrigger" class="fab-btn main-btn">
      <i data-lucide="plus"></i>
    </button>

    <div class="fab-options">
      {% if user.is_authenticated %}
      <a href="{% url 'community' %}" id="comment" class="fab-btn mini-btn" title="Community">
        <i data-lucide="messages-square"></i>
      </a>

      <button id="saveBtn" class="fab-btn mini-btn {% if saved %}save-active{% endif %}" title="Save"
        data-url="{% url 'toggle_read_later' book.slug %}">
        <i data-lucide="bookmark"></i>
      </button>

      <button id="likeBtn" class="fab-btn mini-btn {% if liked %}like-active{% endif %}" title="Like"
        data-url="{% url 'toggle_like' book.slug %}">
        <i data-lucide="thumbs-up"></i>
      </button>
      {% endif %} 
      
      <button id="zoom-out" class="fab-btn mini-btn" title="zoom-out">
        <i data-lucide="zoom-out"></i> 
      </button>
      <button id="zoom-in" class="fab-btn mini-btn" title="zoom-in">
        <i data-lucide="zoom-in"></i> 
      </button>
      <a href="{% url 'library' %}" disabled id="play" class="fab-btn mini-btn" title="library">
        <i data-lucide="house"></i>
      </a>
      <button id="searchpage" class="fab-btn mini-btn" title="search page">
        <i data-lucide="text-select"></i> 
      </button>

      <button disabled id="play" class="fab-btn mini-btn" title="Listen">
        <i data-lucide="play"></i>
      </button>

      <button id="darkModeBtn" class="fab-btn mini-btn" title="Dark Mode">
        <i data-lucide="moon"></i>
      </button>
    </div>

    <div id="toast-notification" class="toast">
      <span id="toast-message"></span>
    </div>
  </div>
  <main id="container-wrapper">
    <section id="container">
      {{ bookcontent|safe }}
    </section>
  </main>
  <div class="pagination-container">

      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="nav-btn">
        <i data-lucide="chevron-left"></i>
      </a>
      {% else %}
      <button class="nav-btn disabled">
        <i data-lucide="chevron-left"></i>
      </button>
      {% endif %}

      <div class="page-info">
        <span class="current-page">Page {{ page_obj.number }}</span>
        <span class="total-pages">of {{ page_obj.paginator.num_pages }}</span>
      </div>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="nav-btn">
        <i data-lucide="chevron-right"></i>
      </a>
      {% else %}
      <button class="nav-btn disabled">
        <i data-lucide="chevron-right"></i>
      </button>
      {% endif %}

    </div>
  <script src="{% static 'js/loading.js' %}"></script>
  {% if book.audio_file %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const audioUrl = '{{ book.audio_file.url }}';
      const playBtn = document.getElementById('play');
      const audioClick = new Audio('/static/sounds/click.mp3');
      
      // Create audio object
      let audioFile = new Audio(audioUrl);

      if (playBtn) {
        playBtn.removeAttribute('disabled');
        playBtn.style.cursor = 'pointer';

        playBtn.addEventListener('click', () => {
          // 2. Play Click Sound
          audioClick.currentTime = 0;
          audioClick.play().catch(e => console.log("Interaction needed first"));

          if (audioFile.paused) {
            // Attempt to play
            let playPromise = audioFile.play();

            if (playPromise !== undefined) {
              playPromise.then(_ => {
                playBtn.innerHTML = '<i data-lucide="pause"></i>';
                lucide.createIcons();
              })
              .catch(error => {
                console.error("Audio playback error:", error);
                if(error.name === "NotSupportedError" || error.message.includes("supported sources")) {
                    alert("Audio file not found or format not supported on this device.");
                }
              });
            }
          } else {
            audioFile.pause();
            playBtn.innerHTML = '<i data-lucide="play"></i>';
            lucide.createIcons();
          }
        });

        audioFile.addEventListener('ended', () => {
           playBtn.innerHTML = '<i data-lucide="play"></i>';
           lucide.createIcons();
        });
        
        audioFile.addEventListener('error', (e) => {
            console.error("Error loading audio file:", audioFile.error);
        });
      }
    });
  </script>
  {% endif %}

  <script>
    // Global Audio Object
    const clicks = new Audio('/static/sounds/click.mp3');
    function playClick() {
        clicks.currentTime = 0;
        clicks.play().catch(e => console.log("User interaction required for audio"));
    }

    document.addEventListener('DOMContentLoaded', () => {
      const toast = document.getElementById('toast-notification');
      const toastMessage = document.getElementById('toast-message');

      function showToast(message) {
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        } else {
            alert(message);
        }
      }

      // --- Page Navigation Logic ---
      const searchbtn = document.getElementById('searchpage');
      const gotobox = document.getElementById('gotobox');
      const goBtn = document.getElementById('goBtn');
      const pageInput = document.getElementById('pageInput');
      const overlaysearch = document.getElementById('overlaysearch');

      function navigateToPage() {
          if (!pageInput) return;

          const pageNum = parseInt(pageInput.value);
          const maxPages = pageInput.dataset.total ? parseInt(pageInput.dataset.total) : 1000; 

          // Validate Page Number
          if (pageNum >= 1 && pageNum <= maxPages) {
              const url = new URL(window.location.href);
              url.searchParams.set('page', pageNum);
              
              if(gotobox) gotobox.style.visibility = "hidden";
              if(searchbtn) searchbtn.classList.remove('tool-active');

              window.location.href = url.toString();
          } else {
              showToast(`That page does not exist. Please enter 1 to ${maxPages}.`);
              pageInput.value = "";
              pageInput.focus();
          }
      }

      // Listeners for Navigation
      if (goBtn) {
          goBtn.addEventListener('click', () => {
              playClick(); // Sound
              navigateToPage();
          });
      }
      if (pageInput) {
          pageInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') navigateToPage();
          });
      }

      // --- Toggle Search Box Visibility ---
      if (searchbtn && gotobox) {
          searchbtn.addEventListener('click', (e) => {
              e.stopPropagation(); 
              playClick(); // Sound

              if (gotobox.style.visibility === "visible") {
                  gotobox.style.visibility = "hidden";
                  gotobox.style.visibility = "hidden";
                  overlaysearch.style.visibility = "hidden";
                  overlaysearch.style.opacity = "0";
                  searchbtn.classList.remove('tool-active');
              } else {
                  gotobox.style.visibility = "visible";
                  overlaysearch.style.visibility = "visible";
                  overlaysearch.style.opacity = "1";
                  searchbtn.classList.add('tool-active');
                  const input = gotobox.querySelector('input');
                  if(input) input.focus();
              }
          });
      }

      // --- Page ZOOM FEATURE ---
      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const containerParagraphs = document.querySelectorAll('#container p');
      let currentFontSize = 16; // Initial Font Size

      // Only run if elements exist
      if(zoomInBtn && zoomOutBtn && containerParagraphs.length > 0) {
          
          // Zoom In Listener
          zoomInBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              playClick();

              if (currentFontSize < 30) { // Max Limit
                  currentFontSize += 2;
                  // Loop through all paragraphs and update size
                  containerParagraphs.forEach(p => {
                      p.style.fontSize = `${currentFontSize}px`;
                  });
                  showToast(`Zoomed In: ${currentFontSize}px`);
              } else {
                  showToast("Max Zoom Reached");
              }
          });

          // Zoom Out Listener
          zoomOutBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              playClick(); // Sound

              if (currentFontSize > 10) { // Min Limit
                  currentFontSize -= 1;
                  containerParagraphs.forEach(p => {
                      p.style.fontSize = `${currentFontSize}px`;
                  });
                  showToast(`Zoomed Out: ${currentFontSize}px`);
              } else {
                  showToast("Min Zoom Reached");
              }
          });
      }

      // --- E. FAB Menu Logic ---
      const fabContainer = document.getElementById('fabContainer');
      const fabTrigger = document.getElementById('fabTrigger');

      if (fabTrigger && fabContainer) { 
          fabTrigger.addEventListener('click', (e) => {
              e.stopPropagation();
              playClick(); // Sound
              fabContainer.classList.toggle('active');

              const closeMenu = (e) => {
                  if (!fabContainer.contains(e.target) && (!gotobox || !gotobox.contains(e.target))) {
                      fabContainer.classList.remove('active'); 
                      
                      if(gotobox) gotobox.style.visibility = "hidden";
                      overlaysearch.style.visibility = "hidden";
                      overlaysearch.style.opacity = "0";
                      if(searchbtn) searchbtn.classList.remove('tool-active');

                      document.removeEventListener('click', closeMenu);
                  }
              };

              if (fabContainer.classList.contains('active')) {
                  document.addEventListener('click', closeMenu);
              }
          });
      }

      // ---Add Click Sound to Link Buttons ---
      const fabLinks = document.querySelectorAll('.fab-options a.fab-btn');
      fabLinks.forEach(link => {
          link.addEventListener('click', () => {
              playClick();
          });
      });

      // --- Dark Mode Logic ---
      const darkModeBtn = document.getElementById('darkModeBtn');
      const body = document.body;

      if (localStorage.getItem('theme') === 'dark') {
        body.classList.add('dark-mode');
        if (darkModeBtn) darkModeBtn.innerHTML = '<i data-lucide="sun"></i>';
      }

      if (darkModeBtn) {
        darkModeBtn.addEventListener('click', () => {
          playClick(); 
          body.classList.toggle('dark-mode');

          const isDark = body.classList.contains('dark-mode');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');

          darkModeBtn.innerHTML = isDark ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>';
          lucide.createIcons();
        });
      }

      // --- Like & Save Buttons ---
      const likeBtn = document.getElementById('likeBtn');
      const saveBtn = document.getElementById('saveBtn');
      const dot = document.querySelector('.dot');

      function burstLikes(count = 30) {
        let i = 0;
        const interval = setInterval(() => {
          if (i >= count) return clearInterval(interval);
          requestAnimationFrame(() => {
            const like = document.createElement('div');
            like.classList.add('like');
            like.textContent = '❤️';
            const size = Math.random() * 16 + 16;
            like.style.cssText = `
              font-size: ${size}px;
              left: ${Math.random() * window.innerWidth}px;
              animation-duration: ${Math.random() * 2 + 2}s;
            `;
            document.body.appendChild(like);
            setTimeout(() => like.remove(), 4000);
          });
          i++;
        }, 20);
      }

      // Save Button
      if (saveBtn) {
        saveBtn.addEventListener('click', function () {
          const url = this.dataset.url;
          const csrfToken = '{{ csrf_token }}';

          const isSaving = !this.classList.contains('save-active');
          this.classList.toggle('save-active'); 
          playClick(); // Sound

          if (isSaving) {
            if (dot) dot.style.display = "block";
          } else {
            if (dot) dot.style.display = "none";
          }

          fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
          })
            .then(response => response.json())
            .then(data => {
              showToast(data.message);
              if (data.status !== 'saved' && data.status !== 'removed') {
                this.classList.toggle('save-active');
                if (dot) dot.style.display = isSaving ? "none" : "block";
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('Something went wrong. Please try again.');
              this.classList.toggle('save-active');
              if (dot) dot.style.display = isSaving ? "none" : "block";
            });
        });
      }

      // Like Button
      if (likeBtn) {
        likeBtn.addEventListener('click', function () {
          const url = this.dataset.url;
          const csrfToken = '{{ csrf_token }}';

          const isLiking = !this.classList.contains('like-active');
          this.classList.toggle('like-active');
          playClick(); // Sound

          if (isLiking) {
            burstLikes(30);
          }

          fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
          })
            .then(response => response.json())
            .then(data => {
              showToast(data.message);
              if (data.status !== 'liked' && data.status !== 'unliked') {
                this.classList.toggle('like-active');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('Something went wrong. Please try again.');
              this.classList.toggle('like-active');
            });
        });
      }

      // --- Login Modal Toggle ---
      const startlogin = document.getElementById('startlogin');
      const loginSection = document.getElementById('loginSection');
      const closelogin = document.getElementById('closelogin');

      if (startlogin && loginSection && closelogin) {
        startlogin.addEventListener('click', () => {
            playClick(); // Sound
            loginSection.classList.add('active');
        });
        closelogin.addEventListener('click', () => {
            playClick(); // Sound
            loginSection.classList.remove('active');
        });
        loginSection.addEventListener('click', (e) => {
          if (e.target === loginSection) loginSection.classList.remove('active');
        });
      }

      // --- Django Messages Fade-Out ---
      const errorDiv = document.querySelector('.error');
      if (errorDiv) {
        const closeButton = errorDiv.querySelector('.error__close');
        const hideError = () => {
          errorDiv.classList.add('fade-out');
          const onAnimationEnd = () => {
            errorDiv.remove();
            errorDiv.removeEventListener('animationend', onAnimationEnd);
          };
          errorDiv.addEventListener('animationend', onAnimationEnd);
        };
        const timer = setTimeout(hideError, 3000);
        if (closeButton) closeButton.addEventListener('click', () => {
          clearTimeout(timer);
          hideError();
        });
      }

      // --- User Dropdown ---
      const dropdownButton = document.getElementById('dropdown-button');
      const dropdownMenu = document.getElementById('dropdown-menu');

      if (dropdownButton && dropdownMenu) {
        dropdownButton.addEventListener('click', (event) => {
          event.stopPropagation();
          playClick(); // Sound
          dropdownMenu.classList.toggle('hidden');
        });

        window.addEventListener('click', (event) => {
          if (!dropdownMenu.contains(event.target) && !dropdownButton.contains(event.target)) {
            dropdownMenu.classList.add('hidden');
          }
        });
      }

      // --- Initialize Lucide Icons ---
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });
  </script>

</body>

</html>