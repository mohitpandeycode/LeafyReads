{% extends 'base.html' %}
{% load static %}

{% block title %}
Community - LeafyReads
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/community.css' %}" />
{% endblock %}

{% block body %}
{% if not user.is_authenticated %}
{% include 'login.html' %}
{% endif %}
{% if messages %}
<div style="z-index: 99; bottom: 10px;left: 5px; top:auto;"
  class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start"
  role="alert">
  <div class="error__icon mr-3">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
      <path fill-rule="evenodd"
        d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z"
        clip-rule="evenodd"></path>
    </svg>
  </div>
  <div class="error__title grow">
    <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  </div>
  <div class="error__close ml-4 cursor-pointer">
    <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
      class="text-gray-700 hover:text-gray-900 transition-colors">
      <path
        d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z">
      </path>
    </svg>
  </div>
</div>
{% endif %}
<div class="comunitycontainer">
  <aside class="sidebar left-sidebar">
    <div class="sidebar-card">
      <h3>üìö Trending Books</h3>
      <ul class="trending-list">
        <li><span class="rank">#1</span> Atomic Habits</li>
        <li><span class="rank">#2</span> The Psychology of Money</li>
        <li><span class="rank">#3</span> Deep Work</li>
        <li><span class="rank">#4</span> Sapiens</li>
        <li><span class="rank">#5</span> Think Again</li>
      </ul>
    </div>
    <div class="sidebar-card">
      <h3>üè∑Ô∏è Popular Tags</h3>
      <div class="tags">
        <span class="tag">#fiction</span>
        <span class="tag">#selfhelp</span>
        <span class="tag">#thriller</span>
        <span class="tag">#romance</span>
        <span class="tag">#scifi</span>
        <span class="tag">#biography</span>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <div class="create-post-card">
      <div class="post-header" style="margin-bottom: 16px;">
        <div class="avatar">
          <img class="profileimage" src="https://i.pravatar.cc/150?u={{ user.username }}" alt="User Avatar">
        </div>
        <span class="username">Share what's on your mind</span>
      </div>

      <form id="postForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mainborder">
          <div id="postContentEditable" contenteditable="true" class="editable-box"></div>
          <textarea name="content" id="postContent" hidden></textarea>
          <div id="activeAttachments">
            <div id="bookInputContainer" class="attachment-row" style="display: none;">
              <input type="hidden" name="book" id="bookMention">
            </div>

            <div id="imagePreviewContainer" class="attachment-row image-row" style="display: none;">
              <img id="imagePreview" src="" alt="Preview">
              <button type="button" class="close-btn" id="removeImage">‚úï</button>
            </div>

            <input type="file" name="image" id="imageInput" accept="image/*" hidden>
          </div>
        </div>

        <hr class="divider">
        <div id="overlay"></div>
        <div class="mentionedbook">
          <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" placeholder="Search books to mention..." />
          </div>

          <div class="watched-section">
            <p style="font-size: 13px;margin-bottom:3px;">Recent Read Books:</p>
            <div class="books">
              {% for book in books %}
              <div class="watched-book flexDA" data-book-id="{{ book.book.slug }}"
                data-book-title="{{ book.book.title }} By {{ book.book.author }}">
                <p class="flexDA" style="font-size: 14px;">
                  <i data-lucide="history"></i>
                  <img style="border-radius: 5px;width:30px;height:35px" src="{{ book.book.cover_front.url }}"
                    alt="bimg">
                  {{ book.book.title }} By {{ book.book.author }}
                </p>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="search-results-section" style="display: none;">
            <p style="font-size: 13px;margin: 10px;padding-top: 10px;">Search Results:</p>
            <div class="books" id="searchResultsList">
            </div>
          </div>
        </div>
        <div class="mentionedbook">
          <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" placeholder="Search books to mention..." />
          </div>
        </div>
        <div class="post-options">
          <div class="tools">
            <button type="button" class="tool-btn" onclick="toggleBookInput(event)">
              <i data-lucide="book-open-check"></i> Mention Book
            </button>
            <button type="button" class="tool-btn" onclick="document.getElementById('imageInput').click()">
              <i data-lucide="image-plus"></i>Upload Photo
            </button>
          </div>
          <button type="submit" class="post-btn">Post</button>
        </div>
      </form>
    </div>

    <div id="postsFeed" class="posts-feed">
      {% if posts %}
      {% for post in posts %}
      <article class="post-card">
        <div class="post-header">
          <div class="avatar">
            <img class="profileimage" src="https://i.pravatar.cc/150?u={{ post.author.username }}"
              alt="{{ post.author.username }}">
          </div>
          <span class="username">{{ post.author.get_full_name }}</span>
          <span class="post-meta">{{ post.created_at|timesince }} ago</span>
          <i style="margin-left: auto;" data-lucide="ellipsis-vertical"></i>
        </div>
        <div class="contentbox">
          <p class="post-content">{{ post.content }}</p>
          {% if post.book %}
          <a href="{% url 'book' post.book.slug %}" class="book-mention">
            <span style="font-size: 20px;padding: 0px 0 6px 0;">üìñ</span> {{ post.book.title }}
          </a>
          {% endif %}
          {% if post.images.all.exists or post.book %}
          <div class="post-images">

            {% if post.book %}
            <img src="{{ post.book.cover_front.url }}" class="post-image" alt="book cover">
            {% endif %}

            {% for image in post.images.all %}
            <img src="{{ image.image.url }}" class="post-image" alt="post image">
            {% endfor %}

          </div>
          {% endif %}
        </div>
        <div class="post-actions">
          <button class="action-btn" onclick="toggleLike(this)">
            <span class="heart">ü§ç</span>
            <span class="count">{{ post.number_of_likes }}</span>
            Like
          </button>
          <button class="action-btn" onclick="openComments(this)">
            <span>üí¨</span>
            <span class="count">{{ post.number_of_comments }}</span>
            Comment
          </button>
          <button class="action-btn" onclick="sharePost(this)">
            <span>‚ÜóÔ∏è</span>
            Share
          </button>
        </div>
      </article>
      {% endfor %}
      {% else %}
      <div class="no-posts">
        <span>üìö</span>
        <p>No posts yet. Be the first to share your thoughts!</p>
      </div>
      {% endif %}
    </div>
  </main>

  <aside class="sidebar right-sidebar">
    <div class="sidebar-card">
      <h3>üë• Active Readers</h3>
      <div class="active-users">
        <div class="user-item">
          <div class="avatar small">A</div>
          <span>Alice M.</span>
          <span class="online-dot"></span>
        </div>
        <div class="user-item">
          <div class="avatar small">B</div>
          <span>Bob K.</span>
          <span class="online-dot"></span>
        </div>
        <div class="user-item">
          <div class="avatar small">C</div>
          <span>Carol J.</span>
          <span class="online-dot"></span>
        </div>
      </div>
    </div>
    <div class="sidebar-card">
      <h3>üìÖ Upcoming Events</h3>
      <div class="events-list">
        <div class="event-item">
          <div class="event-date">
            <span class="day">15</span>
            <span class="month">Dec</span>
          </div>
          <div class="event-info">
            <h4>Book Club Meeting</h4>
            <p>Discussing "1984"</p>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

<div id="commentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Comments</h3>
      <button class="close-modal" id="closeModal">‚úï</button>
    </div>
    <div class="comments-list" id="commentsList">
      <p style="text-align: center; color: #666;">No comments yet.</p>
    </div>
    <div class="add-comment">
      <input type="text" id="commentInput" placeholder="Write a comment...">
      <button id="submitComment">Send</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  //----------------------------------------------------------
  // ELEMENT REFERENCES
  //----------------------------------------------------------
  const editable = document.getElementById("postContentEditable");
  const hiddenTextarea = document.getElementById("postContent");
  const postBtn = document.querySelector(".post-btn");
  const imageInput = document.getElementById("imageInput");
  const postForm = document.getElementById("postForm");
  const bookMentionInput = document.getElementById("bookMention");

  const mentionedBookBox = document.querySelector(".mentionedbook");
  const overlay = document.getElementById("overlay");

  // Search & List Elements
  const searchInput = document.querySelector(".mentionedbook .search-container input");
  const watchedSection = document.querySelector(".watched-section");
  const searchResultsSection = document.querySelector(".search-results-section");
  const searchResultsList = document.getElementById("searchResultsList");

  //----------------------------------------------------------
  // LIVE SEARCH WITH DEBOUNCE
  //----------------------------------------------------------
  let debounceTimer = null;

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim();

    // IF INPUT IS EMPTY: Show Recent, Hide Search
    if (!q) {
      watchedSection.style.display = "block";
      searchResultsSection.style.display = "none";
      searchResultsList.innerHTML = ""; // Clear old results
      return;
    }

    // IF TYPING: Hide Recent, Show Search Container
    watchedSection.style.display = "none";
    searchResultsSection.style.display = "block";
    searchResultsList.innerHTML = `<p style="padding:10px; font-size:13px; color:#666;">Searching...</p>`;

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => performSearch(q), 300);
  });

  function performSearch(query) {
    fetch(`/book/ajax/search/?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        // Handle no results
        if (!data.results || data.results.length === 0) {
          searchResultsList.innerHTML = `<p style="padding:10px; font-size:13px; color:#666;">No books found.</p>`;
          return;
        }

        // Render results using the exact same style as watched books
        searchResultsList.innerHTML = data.results.map(book => `
          <div class="watched-book flexDA search-book-item"
               data-book-slug="${book.slug}"
               data-book-title="${book.title} By ${book.author}">
            <p class="flexDA" style="font-size: 14px;">
              <i data-lucide="search"></i>
              ${book.title} By ${book.author}
            </p>
          </div>
        `).join("");
        if(window.lucide) lucide.createIcons();
        
        // Attach click listeners to the new dynamic results
        attachSearchBookClicks();
      })
      .catch(err => {
        searchResultsList.innerHTML = `<p style="color:red; padding:10px;">Error searching.</p>`;
      });
  }

  //----------------------------------------------------------
  // CLICK HANDLER: DYNAMIC SEARCH RESULTS
  //----------------------------------------------------------
  function attachSearchBookClicks() {
    document.querySelectorAll(".search-book-item").forEach(item => {
      item.addEventListener("click", () => {
        const title = item.dataset.bookTitle;
        const slug = item.dataset.bookSlug;
        selectBook(slug, title);
      });
    });
  }

  //----------------------------------------------------------
  // CLICK HANDLER: RECENT WATCHED BOOKS
  //----------------------------------------------------------
  document.querySelectorAll(".watched-book:not(.search-book-item)").forEach(book => {
    book.addEventListener("click", () => {
      const slug = book.dataset.bookId;
      const title = book.dataset.bookTitle;
      selectBook(slug, title);
    });
  });

  //----------------------------------------------------------
  // SHARED: SELECT BOOK LOGIC
  //----------------------------------------------------------
  function selectBook(slug, title) {
    bookMentionInput.value = slug;
    addBookTag(title);

    // Reset UI
    searchInput.value = "";
    searchResultsSection.style.display = "none";
    watchedSection.style.display = "block";
    mentionedBookBox.style.display = "none";
    overlay.classList.remove("active");

    togglePostButton();
  }

  //----------------------------------------------------------
  // ADD BOOK TAG TO EDITOR
  //----------------------------------------------------------
  function addBookTag(title) {
    // Remove existing tag if user tries to add another (optional, keeps it to 1 book)
    const existing = editable.querySelector(".book-tag");
    if(existing) existing.remove();

    const tag = document.createElement("span");
    tag.classList.add("book-tag");
    tag.setAttribute("contenteditable", "false");
    tag.innerHTML = `üìò ${title} <span class="remove-tag">√ó</span>`;

    editable.appendChild(tag);
    editable.appendChild(document.createTextNode(" ")); // Space after
  }

  editable.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-tag")) {
      e.target.parentElement.remove();
      bookMentionInput.value = "";
      togglePostButton();
    }
  });

  //----------------------------------------------------------
  // SHOW/HIDE POPUP
  //----------------------------------------------------------
  window.toggleBookInput = function (event) {
    event.stopPropagation();
    overlay.classList.add("active");
    mentionedBookBox.style.display = "block";
    searchInput.focus(); // Focus input when opened
  };

  document.addEventListener("click", (event) => {
    if (!mentionedBookBox.contains(event.target) && event.target.closest('.tool-btn') === null) {
      mentionedBookBox.style.display = "none";
      overlay.classList.remove("active");
    }
  });

  //----------------------------------------------------------
  // POST BUTTON STATE
  //----------------------------------------------------------
  function togglePostButton() {
    const clone = editable.cloneNode(true);
    clone.querySelectorAll(".book-tag").forEach(t => t.remove());
    const text = clone.innerText.trim();

    const hasText = text !== "";
    const hasBook = bookMentionInput.value !== "";
    const hasImage = imageInput.files.length > 0;

    if (hasText || hasBook || hasImage) {
      postBtn.removeAttribute("disabled");
      postBtn.style.display = "block";
    } else {
      postBtn.setAttribute("disabled", true);
      postBtn.style.display = "none";
    }
  }

  editable.addEventListener("input", togglePostButton);
  imageInput.addEventListener("change", togglePostButton);
  togglePostButton();

  //----------------------------------------------------------
  // IMAGE PREVIEW
  //----------------------------------------------------------
  const imagePreviewContainer = document.getElementById("imagePreviewContainer");
  const imgPreview = document.getElementById("imagePreview");
  const removeImageBtn = document.getElementById("removeImage");

  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        imgPreview.src = e.target.result;
        imagePreviewContainer.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
    togglePostButton();
  });

  removeImageBtn.addEventListener("click", () => {
    imageInput.value = "";
    imgPreview.src = "";
    imagePreviewContainer.style.display = "none";
    togglePostButton();
  });

  //----------------------------------------------------------
  // FORM SUBMISSION
  //----------------------------------------------------------
  postForm.addEventListener("submit", (e) => {
    const clone = editable.cloneNode(true);
    clone.querySelectorAll(".book-tag").forEach(t => t.remove());
    const caption = clone.innerText.trim();

    if (caption === "" && bookMentionInput.value === "" && imageInput.files.length === 0) {
      e.preventDefault();
      alert("You cannot post empty content.");
      return false;
    }
    hiddenTextarea.value = caption;
  });

});
</script>



{% endblock %}