{% extends 'base.html' %}
{% load static %}
{% load socialaccount %}

{% block meta_description %}
Join the LeafyReads community. Connect with fellow book lovers, share reviews, discuss your favorite novels, and find your next great read together.
{% endblock %}

{% block social_tags %}
<meta property="og:url" content="{{ request.build_absolute_uri }}" />

<meta property="og:title" content="Community - Join the Discussion | LeafyReads" />

<meta property="og:description" content="Connect with book lovers, share thoughts, and discuss your favorite stories on LeafyReads." />

<meta property="og:image" content="{% static 'images/favicon.png' %}" />

<meta property="og:type" content="website" />
{% endblock %}

{% block title %}Community - Connect with Readers | LeafyReads{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/community.css' %}" />
<link rel="stylesheet" href="{% static 'css/mobilehome.css' %}" />
{% endblock %}

{% block body %}
{% if not user.is_authenticated %}
{% include 'login.html' %}
{% endif %}

{% if messages %}
<div style="z-index: 99; bottom: 10px;left: 5px; top:auto;"
  class="error max-w-md w-full fixed top-5 right-5 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start"
  role="alert">
  <div class="error__icon mr-3">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
      <path fill-rule="evenodd"
        d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z"
        clip-rule="evenodd"></path>
    </svg>
  </div>
  <div class="error__title grow">
    <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  </div>
  <div class="error__close ml-4 cursor-pointer">
    <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
      class="text-gray-700 hover:text-gray-900 transition-colors">
      <path
        d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z">
      </path>
    </svg>
  </div>
</div>
{% endif %}

{% if posts.number > 3 %}

<div class="refresh">
  <a href="{% url 'community' %}" class="refresh-btn">
    Back to latest
    <i data-lucide="rotate-ccw"></i>
  </a>
</div>

{% endif %}
<!-- IMAGE POPUP MODAL -->
<div id="imageModal" class="image-modal">
  <span id="closeImageModal" class="close-img-modal">&times;</span>
  <img id="modalImage" class="modal-content-img" loading="lazy" alt="preview" />
</div>

<!-- comment POPUP MODAL -->
<div class="comment-overlay" style="display:none;"></div>
<div class="openpost">
  {% include 'comment.html' %}
</div>
<div class="comunitycontainer">
  <aside class="sidebar left-sidebar">
    <div class="sidebar-card">
      <h3>üìö Trending Books</h3>
      <ul class="trending-list">
        <li><span class="rank">#1</span> Atomic Habits</li>
        <li><span class="rank">#2</span> The Psychology of Money</li>
        <li><span class="rank">#3</span> Deep Work</li>
        <li><span class="rank">#4</span> Sapiens</li>
        <li><span class="rank">#5</span> Think Again</li>
      </ul>
    </div>
    <div class="sidebar-card">
      <h3>üè∑Ô∏è Popular Tags</h3>
      <div class="tags">
        <span class="tag">#fiction</span>
        <span class="tag">#selfhelp</span>
        <span class="tag">#thriller</span>
        <span class="tag">#romance</span>
        <span class="tag">#scifi</span>
        <span class="tag">#biography</span>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <div class="create-post-card">
      <div class="post-header" style="margin-bottom: 16px;">
        <div class="avatar">
          <img class="profileimage" src="https://i.pravatar.cc/150?u={{ user.username }}" alt="User Avatar"
            loading="lazy">
        </div>
        <span class="username">Share what's on your mind</span>
      </div>
      {% if user.is_authenticated %}

      <form id="postForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mainborder">
          <div id="postContentEditable" contenteditable="true" class="editable-box"></div>
          <textarea name="content" id="postContent" hidden></textarea>
          <div id="activeAttachments">
            <div id="bookInputContainer" class="attachment-row" style="display: none;">
              <input type="hidden" name="book" id="bookMention">
            </div>

            <div id="imagePreviewContainer" class="attachment-row image-row" style="display: none;">
              <img id="imagePreview" loading="lazy" alt="Preview">
              <button type="button" class="close-btn" id="removeImage">‚úï</button>
            </div>

            <input type="file" name="image" id="imageInput" accept="image/*" hidden>
          </div>
        </div>

        <hr class="divider">
        <div id="overlay"></div>
        <div class="mentionedbook">
          <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" placeholder="Search books, category, author..." />
          </div>

          <div class="watched-section">
            <p style="font-size: 13px;margin-bottom:3px;">Recent Read Books:</p>
            <div class="books">
              {% for book in books %}
              <div class="watched-book flexDA" data-book-id="{{ book.book.slug }}"
                data-book-title="{{ book.book.title }} By {{ book.book.author }}">
                <p class="flexDA" style="font-size: 14px;">
                  <i data-lucide="history"></i>
                  <img style="border-radius: 5px;width:30px;height:35px" src="{{ book.book.cover_front.url }}"
                    alt="bimg" loading="lazy">
                  {{ book.book.title }} By {{ book.book.author }}
                </p>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="search-results-section" style="display: none;">
            <p style="font-size: 13px;margin: 10px;padding-top: 10px;">Search Results:</p>
            <div class="books" id="searchResultsList">
            </div>
          </div>
        </div>
        <div class="mentionedbook">
          <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" placeholder="Search books to mention..." />
          </div>
        </div>
        <div class="post-options">
          <div class="tools">
            <button type="button" class="tool-btn" onclick="toggleBookInput(event)">
              <i data-lucide="book-open-check"></i> Mention Book
            </button>
            <button type="button" class="tool-btn" onclick="document.getElementById('imageInput').click()">
              <i data-lucide="image-plus"></i>Upload Photo
            </button>
          </div>
          <button type="submit" class="post-btn">Post</button>
        </div>
      </form>
      {% else %}
      <div class="login-reminder">
        <p>üîí <a style="text-decoration: underline;color:#006c9d;font-weight:700;"
            href="{% provider_login_url 'google' %}?next={{request.path}}">Log in</a> to share your thoughts with the
          world.</p>
      </div>
      {% endif %}
    </div>

    <div id="postsFeed" class="posts-feed">
      {% if posts %}
      {% for post in posts %}
      <article class="post-card" data-post-id="{{ post.id }}">
        <div class="post-header">
          <div class="avatar">
            <img class="profileimage" src="https://i.pravatar.cc/150?u={{ post.author.username }}"
              alt="{{ post.author.username }}" loading="lazy">
          </div>
          <div style="display: flex;flex-direction: column;">
            <span class="username">{{ post.author.get_full_name }}</span>
            <span class="post-meta">{{ post.created_at|timesince }} ago</span>
          </div>

          <div class="menu-wrapper" style="margin-left: auto; position: relative;">
            <i class="threedot" style="cursor: pointer;" data-lucide="ellipsis-vertical"></i>

            {% if post.author == request.user %}
            <a href="#" class="postoption deletepost" data-url="{% url 'delete_post' post.id %}"><i style="width: 14px;" data-lucide="trash-2"></i> Delete Post</a>
            {% else %}
            <a href="#" class="postoption"><i style="width: 14px;" data-lucide="flag"></i> Report Post</a>
            {% endif %}
          </div>

        </div>
        <p class="post-content" data-full="{{ post.content }}">{{ post.content }}</p>
        {% if post.book %}
        <a href="{% url 'book' post.book.slug %}" class="book-mention">
          <span style="font-size: 20px;padding: 0px 0 6px 0;">üìñ</span> {{ post.book.title }}
        </a>
        {% endif %}
        {% if post.images.all.exists or post.book %}
        <div class="contentbox">
          <div class="post-images">

            {% if post.book %}
            <img src="{{ post.book.cover_front.url }}?q=auto&f_auto" class="post-image" alt="book cover" loading="lazy">
            {% endif %}

            {% for image in post.images.all %}
            <img src="{{ image.image.url }}?w=500&q=auto&f_auto" class="post-image" alt="post image" loading="lazy">
            {% endfor %}

          </div>
        </div>
        {% endif %}
        <div class="post-actions">
          <button class="action-btn {% if post.has_liked %}liked{% endif %}" data-post-id="{{ post.id }}"
            onclick="toggleLike(this)" {% if not request.user.is_authenticated %}disabled{% endif %}>
            <span class="heart">{% if post.has_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
            <span class="count">{{ post.likes_count }}</span>
            Like
          </button>

          <button class="action-btn" onclick="openComments(this)">
            <span>üí¨</span>
            <span class="count">{{ post.comments_count }}</span>
            Comment
          </button>
        </div>
      </article>
      {% endfor %}
      {% if has_next %}
      <div class="pagination-container">
        <a href="?page={{ next_page_number }}" class="see-more-btn">
          See More Posts
          <i data-lucide="chevron-down"></i>
        </a>
      </div>
      {% endif %}

      {% else %}
      <div class="no-posts">
        <span>üìö</span>
        <p>No posts yet. Be the first to share your thoughts!</p>
      </div>
      {% endif %}
    </div>
  </main>

  <aside class="sidebar right-sidebar">
    <div class="sidebar-card">
      <h3>üë• Active Readers</h3>
      <div class="active-users">
        <div class="user-item">
          <div class="avatar small"><i data-lucide="user-round-check"></i></div>
          <span>Megha Jain</span>
          <span class="online-dot"></span>
        </div>
        <div class="user-item">
          <div class="avatar small"><i data-lucide="user-round-check"></i></div>
          <span>Boby Singh</span>
          <span class="online-dot"></span>
        </div>
        <div class="user-item">
          <div class="avatar small"><i data-lucide="user-round-check"></i></div>
          <span>Mohit Pandey</span>
          <span class="online-dot"></span>
        </div>
      </div>
    </div>
    <div class="sidebar-card">
      <h3>üìÖ Upcoming Events</h3>
      <div class="events-list">
        <div class="event-item">
          <div class="event-date">
            <span class="day">15</span>
            <span class="month">Jan</span>
          </div>
          <div class="event-info">
            <h4>Official Launch</h4>
            <p>Welcome to our Platform</p>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Handle page refresh to new community
    if (window.history.replaceState) {
        // Get the current URL
        const url = new URL(window.location.href);

        // Check if the 'page' parameter exists (e.g., ?page=3)
        if (url.searchParams.has('page')) {
            
            // Remove the 'page' parameter
            url.searchParams.delete('page');

            // Update the URL bar immediately without reloading
            window.history.replaceState({}, '', url.pathname);
        }
    }

    //----------------------------------------------------------
    // 1. HANDLE MESSAGES / ERROR ALERTS (Only if they exist)
    //----------------------------------------------------------
    const errorCloseBtn = document.querySelector('.error__close');
    const errorBox = document.querySelector('.error');

    if (errorCloseBtn && errorBox) {
      errorCloseBtn.addEventListener('click', () => {
        errorBox.style.display = "none";
      });
    }

    //----------------------------------------------------------
    // 2. CREATE POST LOGIC 
    //----------------------------------------------------------
    const postForm = document.getElementById("postForm");
    if (postForm) {

      // --- Element References ---
      const editable = document.getElementById("postContentEditable");
      const hiddenTextarea = document.getElementById("postContent");
      const postBtn = document.querySelector(".post-btn");
      const imageInput = document.getElementById("imageInput");
      const bookMentionInput = document.getElementById("bookMention");

      const mentionedBookBox = document.querySelector(".mentionedbook");
      const overlay = document.getElementById("overlay");

      // --- Search Elements ---
      const searchInput = document.querySelector(".mentionedbook .search-container input");
      const watchedSection = document.querySelector(".watched-section");
      const searchResultsSection = document.querySelector(".search-results-section");
      const searchResultsList = document.getElementById("searchResultsList");
      

      // --- Live Search State ---
      let debounceTimer = null;
      let searchController = null;

      // --- XSS Protection Helper ---
      const escapeHtml = (unsafe) => {
        if (!unsafe) return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      // --- Input Listener ---
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          const q = searchInput.value.trim();
          clearTimeout(debounceTimer);

          // CHANGE: Only search if 2 or more characters
          if (q.length < 2) {
            // Reset UI when empty or just 1 char
            watchedSection.style.display = "block";
            searchResultsSection.style.display = "none";
            searchResultsList.innerHTML = "";

            // Cancel any pending request
            if (searchController) searchController.abort();
            return;
          }

          // Show Results Section immediately
          watchedSection.style.display = "none";
          searchResultsSection.style.display = "block";

          // Render Skeleton Loader
          const skeletonHTML = `
            <div class="skeleton-item">
                <div class="skeleton-icon"></div>
                <div class="skeleton-line"></div>
            </div>`;

          // Repeat skeleton 3 times
          searchResultsList.innerHTML = skeletonHTML + skeletonHTML + skeletonHTML;

          // Debounce API Call (Wait 300ms)
          debounceTimer = setTimeout(() => performSearch(q), 300);
        });
      }

      // --- API Search Logic ---
      async function performSearch(query) {
        // 1. Cancel previous stale request
        if (searchController) searchController.abort();
        searchController = new AbortController();

        try {
          const response = await fetch(`/book/ajax/search/?q=${encodeURIComponent(query)}`, {
            signal: searchController.signal
          });

          if (!response.ok) throw new Error("Network response was not ok");

          const data = await response.json();

          // 2. Handle No Results
          if (!data.results || data.results.length === 0) {
            searchResultsList.innerHTML = `<p style="padding:10px; font-size:13px; color:#666;">No books found.</p>`;
            return;
          }

          // 3. Render Results (Secure Mapping)
          searchResultsList.innerHTML = data.results.map(book => {
            const safeTitle = escapeHtml(book.title);
            const safeAuthor = escapeHtml(book.author);
            const safeSlug = escapeHtml(book.slug);
            const displayTitle = `${safeTitle} By ${safeAuthor}`;

            return `
            <div class="watched-book flexDA search-book-item"
                 data-book-slug="${safeSlug}"
                 data-book-title="${displayTitle}">
              <p class="flexDA" style="font-size: 14px;">
                <i data-lucide="book-plus"></i> 
                ${displayTitle}
              </p>
            </div>
            `;
          }).join("");

          // 4. Performance Optimization: Only scan the new list for icons
          if (window.lucide) {
            lucide.createIcons({
              root: searchResultsList,
              nameAttr: 'data-lucide'
            });
          }

          // 5. Re-attach clicks
          if (typeof attachSearchBookClicks === 'function') {
            attachSearchBookClicks();
          }

        } catch (err) {
          if (err.name === 'AbortError') return;

          console.error("Search Error:", err);
          searchResultsList.innerHTML = `<p style="color:red; padding:10px; font-size:13px;">Error searching.</p>`;
        }
      }

      function attachSearchBookClicks() {
        document.querySelectorAll(".search-book-item").forEach(item => {
          item.addEventListener("click", () => {
            selectBook(item.dataset.bookSlug, item.dataset.bookTitle);
          });
        });
      }

      // --- Recent Watched Book Click ---
      document.querySelectorAll(".watched-book:not(.search-book-item)").forEach(book => {
        book.addEventListener("click", () => {
          selectBook(book.dataset.bookId, book.dataset.bookTitle);
        });
      });

      // --- Book Select Logic ---
      function selectBook(slug, title) {
        bookMentionInput.value = slug;
        addBookTag(title);

        searchInput.value = "";
        searchResultsSection.style.display = "none";
        watchedSection.style.display = "block";
        mentionedBookBox.style.display = "none";
        overlay.classList.remove("active");

        togglePostButton();
      }

      // --- Insert Book Tag ---
      function addBookTag(title) {
        const existing = editable.querySelector(".book-tag");
        if (existing) existing.remove();

        const tag = document.createElement("span");
        tag.classList.add("book-tag");
        tag.setAttribute("contenteditable", "false");
        tag.innerHTML = `üìò ${title} <span class="remove-tag">√ó</span>`;

        editable.appendChild(tag);
        editable.appendChild(document.createTextNode(" "));
      }

      editable.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-tag")) {
          e.target.parentElement.remove();
          bookMentionInput.value = "";
          togglePostButton();
        }
      });

      const mainBorder = document.querySelector(".mainborder");

      // When clicking INSIDE ‚Üí set blue border
      mainBorder.addEventListener("click", (e) => {
        mainBorder.style.border = "1px solid rgb(138 125 255 / 61%)";
        e.stopPropagation();
      });

      // When clicking OUTSIDE ‚Üí reset border
      window.addEventListener("click", (e) => {
        if (!mainBorder.contains(e.target)) {
          mainBorder.style.border = "1px solid #9595952c";
        }
      });

      // --- Book Popup Show/Hide ---
      window.toggleBookInput = function (event) {
        event.stopPropagation();
        overlay.classList.add("active");
        mentionedBookBox.style.display = "block";
        searchInput.focus();
      };

      document.addEventListener("click", (event) => {
        if (mentionedBookBox && !mentionedBookBox.contains(event.target) && event.target.closest('.tool-btn') === null) {
          mentionedBookBox.style.display = "none";
          overlay.classList.remove("active");
        }
      });

      // --- Post Button Enable/Disable ---
      function togglePostButton() {
        const clone = editable.cloneNode(true);
        clone.querySelectorAll(".book-tag").forEach(t => t.remove());

        const text = clone.innerText.trim();
        const hasText = text !== "";
        const hasBook = bookMentionInput.value !== "";
        const hasImage = imageInput.files.length > 0;

        if (hasText || hasBook || hasImage) {
          postBtn.removeAttribute("disabled");
          postBtn.style.display = "block";
        } else {
          postBtn.setAttribute("disabled", true);
          postBtn.style.display = "none";
        }
      }

      editable.addEventListener("input", togglePostButton);
      imageInput.addEventListener("change", togglePostButton);
      togglePostButton();

      // --- Image Preview ---
      const imagePreviewContainer = document.getElementById("imagePreviewContainer");
      const imgPreview = document.getElementById("imagePreview");
      const removeImageBtn = document.getElementById("removeImage");

      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            imgPreview.src = e.target.result;
            imagePreviewContainer.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
        togglePostButton();
      });

      removeImageBtn.addEventListener("click", () => {
        imageInput.value = "";
        imgPreview.src = "";
        imagePreviewContainer.style.display = "none";
        togglePostButton();
      });

      // --- Submit Handler ---
      postForm.addEventListener("submit", (e) => {
        const clone = editable.cloneNode(true);
        clone.querySelectorAll(".book-tag").forEach(t => t.remove());
        const caption = clone.innerText.trim();

        if (caption === "" && bookMentionInput.value === "" && imageInput.files.length === 0) {
          e.preventDefault();
          alert("You cannot post empty content.");
          return;
        }

        hiddenTextarea.value = caption;

        postBtn.disabled = true;
        postBtn.innerText = "Posting...";
        postBtn.style.opacity = "0.6";
        postBtn.style.cursor = "not-allowed";
      });

    } // END OF IF(POSTFORM)
  });

  //---------------------------------------------------
  //Post delete or report action
 //----------------------------------------------------

  // --- 1. CSRF Token Helper ---
    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    const csrftoken = getCookie('csrftoken');


    // --- 2. Custom Toast Function (Uses YOUR HTML) ---
    const showNotification = (message) => {
        // Remove any existing toast first to prevent stacking
        const existingToast = document.querySelector('.js-toast-message');
        if (existingToast) existingToast.remove();

        // Create the container div
        const toast = document.createElement('div');
        toast.className = "js-toast-message error max-w-md w-full fixed bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-start";
        
        // Apply your specific inline positioning and animation styles
        toast.style.cssText = `
            z-index: 99; 
            bottom: 10px; 
            left: 5px; 
            top: auto; 
            position: fixed; 
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        `;

        // Insert YOUR specific HTML structure
        toast.innerHTML = `
            <div class="error__icon mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-green-500" fill="currentColor">
                    <path fill-rule="evenodd" d="m12 1c-6.075 0-11 4.925-11 11s4.925 11 11 11 11-4.925 11-11-4.925-11-11-11zm4.768 9.14c.0878-.1004.1546-.21726.1966-.34383.0419-.12657.0581-.26026.0477-.39319-.0105-.13293-.0475-.26242-.1087-.38085-.0613-.11844-.1456-.22342-.2481-.30879-.1024-.08536-.2209-.14938-.3484-.18828s-.2616-.0519-.3942-.03823c-.1327.01366-.2612.05372-.3782.1178-.1169.06409-.2198.15091-.3027.25537l-4.3 5.159-2.225-2.226c-.1886-.1822-.4412-.283-.7034-.2807s-.51301.1075-.69842.2929-.29058.4362-.29285.6984c-.00228.2622.09851.5148.28067.7034l3 3c.0983.0982.2159.1748.3454.2251.1295.0502.2681.0729.4069.0665.1387-.0063.2747-.0414.3991-.1032.1244-.0617.2347-.1487.3236-.2554z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="error__title grow">
                <ul class="messages" style="list-style:none; padding:0; margin:0;">
                    <li>${message}</li>
                </ul>
            </div>
            <div class="error__close ml-4 cursor-pointer">
                <svg height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="text-gray-700 hover:text-gray-900 transition-colors">
                    <path d="m15.8333 5.34166-1.175-1.175-4.6583 4.65834-4.65833-4.65834-1.175 1.175 4.65833 4.65834-4.65833 4.6583 1.175 1.175 4.65833-4.6583 4.6583 4.6583 1.175-1.175-4.6583-4.6583z"></path>
                </svg>
            </div>
        `;

        // Add close button logic
        toast.querySelector('.error__close').addEventListener('click', () => {
             toast.style.opacity = "0";
             setTimeout(() => toast.remove(), 500);
        });

        document.body.appendChild(toast);

        // Animate In (Fade Up)
        requestAnimationFrame(() => {
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
        });

        // Auto Remove after 4 seconds
        setTimeout(() => {
            if (document.body.contains(toast)) {
                toast.style.opacity = "0";
                toast.style.transform = "translateY(20px)";
                setTimeout(() => toast.remove(), 500);
            }
        }, 4000);
    };


    // --- 3. Main Event Listener (Toggle + Delete) ---
    document.addEventListener('click', (e) => {
        const target = e.target;

        // A. Toggle Menu
        const dotBtn = target.closest('.threedot');
        if (dotBtn) {
            e.stopPropagation();
            const wrapper = dotBtn.closest('.menu-wrapper');
            const menu = wrapper.querySelector('.postoption');

            document.querySelectorAll('.postoption').forEach(el => {
                if (el !== menu) el.style.display = 'none';
            });

            if (menu) {
                menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
            }
            return;
        }

        // B. Close Menu
        if (!target.closest('.postoption')) {
            document.querySelectorAll('.postoption').forEach(el => el.style.display = 'none');
        }

        // C. DELETE POST ACTION
        const deleteBtn = target.closest('.deletepost');
        if (deleteBtn) {
            e.preventDefault();

            if (!confirm("Are you sure you want to delete this post?")) return;

            const url = deleteBtn.getAttribute('data-url');
            const postCard = deleteBtn.closest('.post-card'); 

            // Visual feedback
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = 'Deleting...';
            deleteBtn.style.opacity = '0.7';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 1. USE THE CUSTOM NOTIFICATION
                    showNotification(data.message); 

                    // 2. Remove the post smoothly
                    postCard.style.transition = "all 0.5s ease";
                    postCard.style.opacity = "0";
                    postCard.style.transform = "translateX(20px)";
                    setTimeout(() => postCard.remove(), 500);
                } else {
                    // Show error using the same notification style (optional)
                    showNotification(data.message || "Error deleting post");
                    deleteBtn.textContent = originalText;
                    deleteBtn.style.opacity = '1';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification("Something went wrong.");
                deleteBtn.textContent = originalText;
                deleteBtn.style.opacity = '1';
            });
        }
    });


  //----------------------------------------------------------
  //  post caption see more option
  //----------------------------------------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const MAX_CHARS = 1000;

    document.querySelectorAll(".post-content").forEach(contentEl => {
      const fullText = contentEl.dataset.full.trim();

      if (fullText.length <= MAX_CHARS) return; // No need to shorten

      const shortText = fullText.substring(0, MAX_CHARS) + "...";

      // Create read more link
      const readMore = document.createElement("span");
      readMore.className = "read-more-btn";
      readMore.innerText = " Read more";

      contentEl.innerText = shortText;
      contentEl.appendChild(readMore);

      let expanded = false;

      readMore.addEventListener("click", () => {
        if (!expanded) {
          contentEl.innerText = fullText + " ";
          readMore.innerText = " Read less";
          contentEl.appendChild(readMore);
          expanded = true;
        } else {
          contentEl.innerText = shortText;
          readMore.innerText = " Read more";
          contentEl.appendChild(readMore);
          expanded = false;
        }
      });
    });
  });



  //----------------------------------------------------------
  //  REAL-TIME LIKE SYSTEM (AJAX)
  //----------------------------------------------------------
  function toggleLike(btn) {
    const postId = btn.dataset.postId;
    const heartSpan = btn.querySelector('.heart');
    const countSpan = btn.querySelector('.count');

    const isCurrentlyLiked = btn.classList.contains('liked');
    let currentCount = parseInt(countSpan.innerText);

    if (isCurrentlyLiked) {
      btn.classList.remove('liked');
      heartSpan.innerText = 'ü§ç';
      countSpan.innerText = Math.max(0, currentCount - 1);
    } else {
      btn.classList.add('liked');
      heartSpan.innerText = '‚ù§Ô∏è';
      countSpan.innerText = currentCount + 1;
    }

    const formData = new FormData();
    formData.append('post_id', postId);
    // Note: Ensure csrf_token is available in context or use cookie
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "like_post" %}', {
      method: 'POST',
      body: formData
    })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (data.is_liked) {
          btn.classList.add('liked');
          heartSpan.innerText = '‚ù§Ô∏è';
        } else {
          btn.classList.remove('liked');
          heartSpan.innerText = 'ü§ç';
        }
        countSpan.innerText = data.likes_count;
      })
      .catch(error => {
        console.error('Error:', error);
        if (isCurrentlyLiked) {
          btn.classList.add('liked');
          heartSpan.innerText = '‚ù§Ô∏è';
          countSpan.innerText = currentCount;
        } else {
          btn.classList.remove('liked');
          heartSpan.innerText = 'ü§ç';
          countSpan.innerText = currentCount;
        }
      });
  }

  //----------------------------------------------------------
  //  REAL-TIME COMMENT SYSTEM (AJAX)
  //----------------------------------------------------------
  let activePostId = null;

  function openComments(btn) {
    const postCard = btn.closest(".post-card");
    activePostId = postCard.dataset.postId;

    document.querySelector(".comment-overlay").style.display = "block";
    document.getElementById("commentModal").style.display = "block";
    document.body.style.overflow = "hidden";

    loadComments(activePostId);
  }

  function loadComments(postId) {
    const list = document.getElementById("commentList");
    const commentOwner = document.getElementById("commentOwner");


    // Clear previous data
    commentOwner.innerHTML = "";

    // Skeleton Loader
    list.innerHTML = `
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
    `;

    fetch(`/community/comment/${postId}/`)
      .then(res => res.json())
      .then(data => {
        list.innerHTML = "";

        // ------------------------------------------------------
        // 1. RENDER POST OWNER INFO
        // ------------------------------------------------------
        if (data.post) {
          commentOwner.innerHTML = `
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <div class="avatar">
                            <img class="profileimage" style="border: 3px solid green;" src="${data.post.avatar}" alt="ownerimg" loading="lazy">
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center; width: 100%;">
                            <div style="display:flex; align-items:center; gap:10px">
                                <span class="username" style="font-weight:bold;">${data.post.author}</span>
                                <span class="post-meta" style="font-size:12px; color:#666;">${data.post.created} ago</span>
                            </div>
                            <p class="ownertext">${data.post.content}</p>
                        </div>
                    </div>
                `;
        }

        // ------------------------------------------------------
        // 2. CHECK FOR COMMENTS
        // ------------------------------------------------------
        if (!data.comments || data.comments.length === 0) {
          list.innerHTML = `
                    <div style="text-align:center; padding:40px 10px; color:var(--text-muted); font-size:15px;">
                        <i data-lucide="message-circle" style="width:38px;height:38px;margin-bottom:8px;"></i>
                        <div>No comments yet</div>
                        <div style="font-size:14px;">Be the first to comment!</div>
                    </div>
                `;
          if (window.lucide) lucide.createIcons();
          return;
        }

        // ------------------------------------------------------
        // 3. RENDER COMMENTS
        // ------------------------------------------------------
        data.comments.forEach(c => {
          list.innerHTML += `
                    <div class="comment-card">
                        <div class="avatar">
                            <img class="profileimage" src="${c.avatar}" alt="profile" loading="lazy" />
                        </div>
                        <div class="comment-lines" style="margin-top:0">
                            <div style="font-weight:600;font-size:15px">
                                ${c.author}
                            </div>
                            <div style="font-size:14px;line-height:1.5">
                                ${c.content}
                            </div>
                            <div style="display:flex;gap:16px;margin-top:6px">
                                <span style="font-size:13px;color:var(--text-muted);">${c.created}</span>
                                <span style="font-size:13px;color:var(--accent);cursor:pointer">Like</span>
                                <span style="font-size:13px;color:var(--accent);cursor:pointer">Reply</span>
                            </div>
                        </div>
                    </div>
                `;
        });
      })
      .catch(err => {
        console.error("Error loading comments:", err);
        list.innerHTML = `<div style="text-align:center;">Unable to load comments</div>`;
      });
  }

  // Add check here too: Button only exists if modal exists
  const sendCommentBtn = document.getElementById("sendCommentBtn");
  if (sendCommentBtn) {
    sendCommentBtn.addEventListener("click", () => {
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return;

      const formData = new FormData();
      formData.append("post_id", activePostId);
      formData.append("content", text);
      
      const tokenInput = document.querySelector("input[name=csrfmiddlewaretoken]");
      if (tokenInput) formData.append("csrfmiddlewaretoken", tokenInput.value);

      fetch("/community/comment/add/", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(() => {
          document.getElementById("commentInput").value = "";
          loadComments(activePostId);
          // Find the specific post card on the background page
          const postCard = document.querySelector(`.post-card[data-post-id="${activePostId}"]`);
          if (postCard) {
              // Find the comment count span within that card
              const countSpan = postCard.querySelector('button[onclick="openComments(this)"] .count');       
              if (countSpan) {
                  let currentCount = parseInt(countSpan.innerText) || 0;
                  countSpan.innerText = currentCount + 1;
              }
          }
        });
    });
  }

  const closeComment = document.getElementById("closeComment");
  if (closeComment) {
    closeComment.addEventListener('click', () => {
      document.getElementById("commentModal").style.display = "none";
      document.querySelector(".comment-overlay").style.display = "none";
      document.body.style.overflow = "auto";

    });
  }

  // -------------------------------------------------
  // Show image on full size when click on post images
  // -------------------------------------------------

  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    const closeBtn = document.getElementById("closeImageModal");

    // Attach click event to all post images
    document.querySelectorAll(".post-image").forEach(img => {
      img.addEventListener("click", () => {
        modal.style.display = "flex";
        modalImg.src = img.src;
        document.body.style.overflow = "hidden";
      });
    });

    // Close modal
    closeBtn.onclick = () => {
      modal.style.display = "none";
      document.body.style.overflow = "auto";
    };

    // Close when background clicked
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });
  });

</script>




{% endblock %}