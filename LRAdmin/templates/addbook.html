{% extends 'basic.html' %}
{% load static %}
{% load cloudinary %}
{% block title %}
Add Book - LeafyReads Admin
{% endblock title %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/addBook.css' %}" />
<style>
    .errorlist { color: #ff6b6b; list-style: none; padding: 0; margin: 5px 0 0 0; font-size: 0.85em; }
    
    /* Make the whole image area clickable */
    .image-upload-label {
        display: block;
        position: relative;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }
    
    /* Ensure image fits */
    .image-upload-label img {
        width: 100%;
        height: auto;
        display: block;
        min-height: 200px; /* Ensure clickable area even if image is missing */
        object-fit: cover;
    }
</style>
{% endblock %}

{% block body %}
<div class="addbookcontainer">
    <h1>Add Book - LeafyReads</h1>
    
    {% if book_form.non_field_errors %}
        <div class="alert alert-danger">{{ book_form.non_field_errors }}</div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-actions">
            <button type="submit" name="action" value="save" class="btn-primary">Save</button>
            <button type="submit" name="action" value="add_another" class="btn-primary">Save and Add Another</button>
            <button type="submit" name="action" value="continue" class="btn-secondary">Save and Continue Editing</button>
        </div>

        <div class="split-layout">
            <div class="form-left">
                
                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.title.id_for_label }}">Title <span style="color: red;">*</span></label>
                    {{ book_form.title }}
                    {{ book_form.title.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.slug.id_for_label }}">Slug <span style="color: red;">*</span></label>
                    {{ book_form.slug }}
                    {{ book_form.slug.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.author.id_for_label }}">Author <span style="color: red;">*</span></label>
                    {{ book_form.author }}
                    {{ book_form.author.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.genre.id_for_label }}">Genre <span style="color: red;">*</span></label>
                    {{ book_form.genre }}
                    {{ book_form.genre.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.book_language.id_for_label }}">Book Language <span style="color: red;">*</span></label>
                    {{ book_form.book_language }}
                    {{ book_form.book_language.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.price.id_for_label }}">Price</label>
                    {{ book_form.price }}
                    {{ book_form.price.errors }}
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="{{ book_form.isbn.id_for_label }}">ISBN</label>
                    {{ book_form.isbn }}
                    {{ book_form.isbn.errors }}
                </div>

                <label>Front Cover <span style="color: red;">*</span></label>
                <div class="image-upload">
                    <label for="{{ book_form.cover_front.id_for_label }}" class="image-upload-label">
                        {% cloudinary "cvhpzkazi3wilcmccljw" loading="lazy" quality="auto" fetch_format="auto" alt="Cover Front"  %}
                        <div class="overlay">ðŸ“·</div>
                    </label>

                    <div style="display: none;">
                        {{ book_form.cover_front }}
                    </div>
                    
                    {{ book_form.cover_front.errors }}
                </div>

                <div class="checkbox" style="display: flex; align-items: center; gap: 10px;">
                    <label style="color: white; margin: 0;" for="{{ book_form.is_published.id_for_label }}">
                        Is Published <span style="color: red;">*</span>
                    </label>

                    <label class="switch">
                        {{ book_form.is_published }}
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="file-input">
                    <label for="{{ book_form.audio_file.id_for_label }}">Audio File</label>
                    {{ book_form.audio_file }}
                    {{ book_form.audio_file.errors }}
                </div>
            </div>

            <div class="form-right">
                {{ content_form.media }}
                
                <label for="{{ content_form.content.id_for_label }}">Book Content <span style="color: red;">*</span></label>
                {{ content_form.content }}
                {{ content_form.content.errors }}

                <div class="form-actions">
                    <button type="submit" name="action" value="save" class="btn-primary">Save</button>
                    <button type="submit" name="action" value="add_another" class="btn-primary">Save and Add Another</button>
                    <button type="submit" name="action" value="continue" class="btn-secondary">Save and Continue Editing</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // 1. Auto-Slug Script
    const titleInput = document.getElementById('{{ book_form.title.id_for_label }}'); 
    const slugInput = document.getElementById('{{ book_form.slug.id_for_label }}');

    if (titleInput && slugInput) {
        titleInput.addEventListener('keyup', function() {
            slugInput.value = titleInput.value
                .toLowerCase()
                .replace(/[^\w ]+/g, '')
                .replace(/ +/g, '-');
        });
    }

    // 2. Image Preview Script
    const coverInput = document.getElementById('{{ book_form.cover_front.id_for_label }}');
    
    if (coverInput) {
        coverInput.addEventListener('change', function(event) {
            const reader = new FileReader();
            reader.onload = function() {
                const preview = document.getElementById('preview');
                if(preview) preview.src = reader.result;
            }
            if(event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        });
    }
</script>
{% endblock body %}